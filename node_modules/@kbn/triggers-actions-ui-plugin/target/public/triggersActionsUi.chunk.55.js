/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.triggersActionsUi_bundle_jsonpfunction=window.triggersActionsUi_bundle_jsonpfunction||[]).push([[55],{79:function(e,t,a){"use strict";a.r(t),a.d(t,"default",(function(){return k}));var s=a(1),n=a.n(s),c=a(26),i=a(3),r=a(2),l=a(11),u=a(21),o=a(12),d=a(19),j=a(177),b=a(172),m=a(142),p=a(6),f=a(34);const g=({ruleTypeId:e,actions:t,...a})=>({...a,rule_type_id:e,actions:t.map((({group:e,id:t,params:a,frequency:s,alertsFilter:n,useAlertDataForTemplate:c})=>({group:e,id:t,params:a,frequency:{notify_when:s.notifyWhen,throttle:s.throttle,summary:s.summary},alerts_filter:n,...void 0!==c?{use_alert_data_for_template:c}:{}})))});var y=a(55),O=a(139),v=a(0);const x=({onConfirm:e,onCancel:t})=>Object(v.jsx)(i.EuiConfirmModal,{title:r.i18n.translate("xpack.triggersActionsUI.sections.confirmRuleSave.confirmRuleSaveTitle",{defaultMessage:"Save rule with no actions?"}),onCancel:t,onConfirm:e,confirmButtonText:r.i18n.translate("xpack.triggersActionsUI.sections.confirmRuleSave.confirmRuleSaveConfirmButtonText",{defaultMessage:"Save rule"}),cancelButtonText:r.i18n.translate("xpack.triggersActionsUI.sections.confirmRuleSave.confirmRuleSaveCancelButtonText",{defaultMessage:"Cancel"}),defaultFocusedButton:"confirm","data-test-subj":"confirmRuleSaveModal"},Object(v.jsx)("p",null,Object(v.jsx)(c.FormattedMessage,{id:"xpack.triggersActionsUI.sections.confirmRuleSave.confirmRuleSaveWithoutActionsMessage",defaultMessage:"You can add an action at anytime."})));var S=a(173),h=a(117),C=a(124);const E=({isSaving:e,onSave:t,onCancel:a,isFormLoading:s})=>{const{loadingHealthCheck:l}=Object(C.b)();return Object(v.jsx)(i.EuiFlyoutFooter,null,Object(v.jsx)(i.EuiFlexGroup,{justifyContent:"spaceBetween"},Object(v.jsx)(i.EuiFlexItem,{grow:!1},Object(v.jsx)(i.EuiButtonEmpty,{"data-test-subj":"cancelSaveRuleButton",onClick:a},r.i18n.translate("xpack.triggersActionsUI.sections.ruleAddFooter.cancelButtonLabel",{defaultMessage:"Cancel"}))),s?Object(v.jsx)(i.EuiFlexItem,{grow:!1},Object(v.jsx)(i.EuiSpacer,{size:"s"}),Object(v.jsx)(i.EuiLoadingSpinner,{size:"l"})):Object(v.jsx)(n.a.Fragment,null),Object(v.jsx)(i.EuiFlexItem,{grow:!1},Object(v.jsx)(i.EuiButton,{fill:!0,color:"success","data-test-subj":"saveRuleButton",type:"submit",iconType:"check",isDisabled:l,isLoading:e,onClick:t},Object(v.jsx)(c.FormattedMessage,{id:"xpack.triggersActionsUI.sections.ruleAddFooter.saveButtonLabel",defaultMessage:"Save"})))))};var T=a(30),I=a(174),R=a(57),A=a(134),F=a(205),M=a(129);const w=r.i18n.translate("xpack.triggersActionsUI.sections.ruleAdd.saveErrorNotificationText",{defaultMessage:"Cannot create rule."}),k=({consumer:e,ruleTypeRegistry:t,actionTypeRegistry:a,onClose:n,canChangeTrigger:k,ruleTypeId:B,initialValues:U,reloadRules:_,onSave:L,hideGrouping:N,hideInterval:D,metadata:P,filteredRuleTypes:z,validConsumers:G,useRuleProducer:W,initialSelectedConsumer:q,...H})=>{var V;const J=null!=L?L:_,[Y,$]=Object(s.useState)(P),K=Object(s.useCallback)((e=>$(e)),[]),Q=Object(s.useMemo)((()=>({params:{},consumer:e,ruleTypeId:B,schedule:{interval:p.e},actions:[],tags:[],...U||{}})),[B,e,U]),[{rule:X},Z]=Object(s.useReducer)(m.a,{rule:Q}),[ee,te]=Object(s.useState)({isUsingSecurity:!1}),[ae,se]=Object(s.useState)({}),[ne,ce]=Object(s.useState)(!1),[ie,re]=Object(s.useState)(!1),[le,ue]=Object(s.useState)(!1),[oe,de]=Object(s.useState)(H.ruleTypeIndex),[je,be]=Object(s.useState)(!1),me=Object(s.useMemo)((()=>X.ruleTypeId&&p.l.includes(X.ruleTypeId)),[X]),[pe,fe]=Object(s.useState)(me?q:null),ge=(e,t)=>{Z({command:{type:"setProperty"},payload:{key:e,value:t}})},{http:ye,notifications:{toasts:Oe},application:{capabilities:ve}}=Object(T.b)().services,xe=Object(h.f)(ve);Object(s.useEffect)((()=>{(async()=>{te(await Object(A.a)({http:ye}))})()}),[ye]),Object(s.useEffect)((()=>{B&&ge("ruleTypeId",B)}),[B]),Object(s.useEffect)((()=>{H.ruleTypeIndex||(async()=>{const e=await Object(y.a)({http:ye}),t=new Map;for(const a of e)t.set(a.id,a);de(t)})()}),[H.ruleTypeIndex,ye]),Object(s.useEffect)((()=>{Object(l.isEmpty)(X.params)&&!Object(l.isEmpty)(ae)?se({}):Object(l.isEmpty)(ae)&&se(X.params)}),[X.params,ae]);const[Se,he]=Object(s.useState)([]),[Ce,Ee]=Object(s.useState)(!1);Object(s.useEffect)((()=>{(async()=>{Ee(!0);const e=await Object(b.a)(X.actions,a);Ee(!1),he([...e])})()}),[X.actions,a]),Object(s.useEffect)((()=>{var e;!ee.minimumScheduleInterval||null!=U&&null!==(e=U.schedule)&&void 0!==e&&e.interval||ge("schedule",{interval:Object(F.a)(ee.minimumScheduleInterval.value)})}),[ee.minimumScheduleInterval,U]),Object(s.useEffect)((()=>{if(X.ruleTypeId&&oe){const e=oe.get(X.ruleTypeId);null!=e&&e.defaultScheduleInterval&&!je&&ge("schedule",{interval:e.defaultScheduleInterval})}}),[X.ruleTypeId,oe,X.schedule.interval,je]),Object(s.useEffect)((()=>{X.schedule.interval===p.e||je||be(!0)}),[X.schedule.interval,je]);const Te=()=>{Object(I.a)(X,Q,!1)||Object(I.b)(X.params,ae)?ue(!0):n(d.m.CANCELED,Y)},Ie=async()=>{const e=await async function(){try{const e=await async function({http:e,rule:t}){const a=await e.post(`${p.b}/rule`,{body:JSON.stringify(g(t))});return Object(f.b)(a)}({http:ye,rule:{...X,...me&&pe?{consumer:pe}:{}}});return Oe.addSuccess(r.i18n.translate("xpack.triggersActionsUI.sections.ruleAdd.saveSuccessNotificationText",{defaultMessage:'Created rule "{ruleName}"',values:{ruleName:e.name}})),e}catch(t){var e;const a=Object(o.parseRuleCircuitBreakerErrorMessage)((null===(e=t.body)||void 0===e?void 0:e.message)||w);Oe.addDanger({title:a.summary,...a.details&&{text:Object(u.toMountPoint)(Object(v.jsx)(M.a,null,a.details))}})}}();ce(!1),e&&(n(d.m.SAVED,Y),J&&J(Y))},Re=X.ruleTypeId?t.get(X.ruleTypeId):null,{ruleBaseErrors:Ae,ruleErrors:Fe,ruleParamsErrors:Me}=Object(s.useMemo)((()=>Object(b.b)({...X,...me&&void 0!==pe?{consumer:pe}:{}},Re,ee)),[X,pe,me,Re,ee]),we=xe&&0===(null===(V=X.actions)||void 0===V?void 0:V.length);return Object(v.jsx)(i.EuiPortal,null,Object(v.jsx)(i.EuiFlyout,{onClose:Te,"aria-labelledby":"flyoutRuleAddTitle",size:"m",maxWidth:620,ownFocus:!0},Object(v.jsx)(i.EuiFlyoutHeader,{hasBorder:!0},Object(v.jsx)(i.EuiTitle,{size:"s","data-test-subj":"addRuleFlyoutTitle"},Object(v.jsx)("h3",{id:"flyoutTitle"},Object(v.jsx)(c.FormattedMessage,{defaultMessage:"Create rule",id:"xpack.triggersActionsUI.sections.ruleAdd.flyoutTitle"})))),Object(v.jsx)(C.a,null,Object(v.jsx)(O.a,{inFlyout:!0,waitForCheck:!0},Object(v.jsx)(i.EuiFlyoutBody,null,Object(v.jsx)(j.a,{canShowConsumerSelection:!0,rule:X,config:ee,dispatch:Z,errors:Fe,canChangeTrigger:k,operation:r.i18n.translate("xpack.triggersActionsUI.sections.ruleAdd.operationName",{defaultMessage:"create"}),validConsumers:G,selectedConsumer:pe,actionTypeRegistry:a,ruleTypeRegistry:t,metadata:Y,filteredRuleTypes:z,hideGrouping:N,hideInterval:D,onChangeMetaData:K,setConsumer:fe,useRuleProducer:W,initialSelectedConsumer:q})),Object(v.jsx)(E,{isSaving:ne,isFormLoading:Ce,onSave:async()=>{if(ce(!0),Ce||!Object(b.c)(X,Fe,Se))return e=Object(R.a)(X,Me,Ae,Se),Z({command:{type:"setRule"},payload:{key:"rule",value:e}}),void ce(!1);var e;we?re(!0):await Ie()},onCancel:Te}))),ie&&Object(v.jsx)(x,{onConfirm:async()=>{re(!1),await Ie()},onCancel:()=>{ce(!1),re(!1)}}),le&&Object(v.jsx)(S.a,{onConfirm:()=>{ue(!1),n(d.m.CANCELED,Y)},onCancel:()=>{ue(!1)}})))}}}]);