"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.AlertsTableState = void 0;
var _react = _interopRequireWildcard(require("react"));
var _lodash = require("lodash");
var _eui = require("@elastic/eui");
var _ruleDataUtils = require("@kbn/rule-data-utils");
var _public = require("@kbn/kibana-utils-plugin/public");
var _public2 = require("@kbn/kibana-react-plugin/public");
var _reactQuery = require("@tanstack/react-query");
var _use_get_muted_alerts = require("./hooks/alert_mute/use_get_muted_alerts");
var _use_fetch_alerts = require("./hooks/use_fetch_alerts");
var _alerts_table = require("./alerts_table");
var _empty_state = require("./empty_state");
var _translations = require("./translations");
var _reducer = require("./bulk_actions/reducer");
var _use_columns = require("./hooks/use_columns");
var _inspect = require("./toolbar/components/inspect");
var _query_client = require("./query_client");
var _use_bulk_get_cases = require("./hooks/use_bulk_get_cases");
var _use_bulk_get_maintenance_windows = require("./hooks/use_bulk_get_maintenance_windows");
var _alerts_table_context = require("./contexts/alerts_table_context");
function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function (nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }
function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }
/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

const DefaultPagination = {
  pageSize: 10,
  pageIndex: 0
};
const EmptyConfiguration = {
  id: '',
  columns: [],
  sort: [],
  getRenderCellValue: () => () => null
};
const getCaseIdsFromAlerts = alerts => new Set(alerts.filter(alert => {
  const caseIds = alert[_ruleDataUtils.ALERT_CASE_IDS];
  return caseIds != null && caseIds.length > 0;
}).map(alert => alert[_ruleDataUtils.ALERT_CASE_IDS]).flat());
const getMaintenanceWindowIdsFromAlerts = alerts => new Set(alerts.filter(alert => {
  const maintenanceWindowIds = alert[_ruleDataUtils.ALERT_MAINTENANCE_WINDOW_IDS];
  return maintenanceWindowIds != null && maintenanceWindowIds.length > 0;
}).map(alert => alert[_ruleDataUtils.ALERT_MAINTENANCE_WINDOW_IDS]).flat());
const isCasesColumnEnabled = columns => columns.some(({
  id
}) => id === _ruleDataUtils.ALERT_CASE_IDS);
const isMaintenanceWindowColumnEnabled = columns => columns.some(({
  id
}) => id === _ruleDataUtils.ALERT_MAINTENANCE_WINDOW_IDS);
const AlertsTableState = props => {
  return /*#__PURE__*/_react.default.createElement(_reactQuery.QueryClientProvider, {
    client: _query_client.alertsTableQueryClient,
    context: _alerts_table_context.AlertsTableQueryContext
  }, /*#__PURE__*/_react.default.createElement(AlertsTableStateWithQueryProvider, props));
};
exports.default = exports.AlertsTableState = AlertsTableState;
const AlertsTableStateWithQueryProvider = ({
  alertsTableConfigurationRegistry,
  configurationId,
  id,
  featureIds,
  query,
  pageSize,
  leadingControlColumns,
  rowHeightsOptions,
  renderCellValue,
  columns: propColumns,
  gridStyle,
  browserFields: propBrowserFields,
  onUpdate,
  onLoaded,
  runtimeMappings,
  showAlertStatusWithFlapping,
  toolbarVisibility,
  shouldHighlightRow,
  dynamicRowHeight,
  lastReloadRequestTime
}) => {
  var _alertsTableConfigura, _alertsTableConfigura2, _alertsTableConfigura3, _alertsTableConfigura4, _alertsTableConfigura6, _alertsTableConfigura7, _alertsTableConfigura8, _alertsTableConfigura9, _alertsTableConfigura10, _alertsTableConfigura11;
  const {
    cases: casesService
  } = (0, _public2.useKibana)().services;
  const hasAlertsTableConfiguration = (_alertsTableConfigura = alertsTableConfigurationRegistry === null || alertsTableConfigurationRegistry === void 0 ? void 0 : alertsTableConfigurationRegistry.has(configurationId)) !== null && _alertsTableConfigura !== void 0 ? _alertsTableConfigura : false;
  if (!hasAlertsTableConfiguration)
    // eslint-disable-next-line no-console
    console.warn(`Missing Alert Table configuration for configuration ID: ${configurationId}`);
  const alertsTableConfiguration = hasAlertsTableConfiguration ? alertsTableConfigurationRegistry.get(configurationId) : EmptyConfiguration;
  const storage = (0, _react.useRef)(new _public.Storage(window.localStorage));
  const localStorageAlertsTableConfig = storage.current.get(id);
  const persistentControls = alertsTableConfiguration === null || alertsTableConfiguration === void 0 ? void 0 : (_alertsTableConfigura2 = alertsTableConfiguration.usePersistentControls) === null || _alertsTableConfigura2 === void 0 ? void 0 : _alertsTableConfigura2.call(alertsTableConfiguration);
  const showInspectButton = (_alertsTableConfigura3 = alertsTableConfiguration === null || alertsTableConfiguration === void 0 ? void 0 : alertsTableConfiguration.showInspectButton) !== null && _alertsTableConfigura3 !== void 0 ? _alertsTableConfigura3 : false;
  const columnConfigByClient = propColumns && !(0, _lodash.isEmpty)(propColumns) ? propColumns : (_alertsTableConfigura4 = alertsTableConfiguration === null || alertsTableConfiguration === void 0 ? void 0 : alertsTableConfiguration.columns) !== null && _alertsTableConfigura4 !== void 0 ? _alertsTableConfigura4 : [];
  const columnsLocal = localStorageAlertsTableConfig && localStorageAlertsTableConfig.columns && !(0, _lodash.isEmpty)(localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.columns) ? localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.columns : columnConfigByClient;
  const getStorageConfig = () => {
    var _alertsTableConfigura5;
    return {
      columns: columnsLocal,
      sort: localStorageAlertsTableConfig && localStorageAlertsTableConfig.sort && !(0, _lodash.isEmpty)(localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.sort) ? localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.sort : (_alertsTableConfigura5 = alertsTableConfiguration === null || alertsTableConfiguration === void 0 ? void 0 : alertsTableConfiguration.sort) !== null && _alertsTableConfigura5 !== void 0 ? _alertsTableConfigura5 : [],
      visibleColumns: localStorageAlertsTableConfig && localStorageAlertsTableConfig.visibleColumns && !(0, _lodash.isEmpty)(localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.visibleColumns) ? localStorageAlertsTableConfig === null || localStorageAlertsTableConfig === void 0 ? void 0 : localStorageAlertsTableConfig.visibleColumns : columnsLocal.map(c => c.id)
    };
  };
  const storageAlertsTable = (0, _react.useRef)(getStorageConfig());
  storageAlertsTable.current = getStorageConfig();
  const [sort, setSort] = (0, _react.useState)(storageAlertsTable.current.sort);
  const [pagination, setPagination] = (0, _react.useState)({
    ...DefaultPagination,
    pageSize: pageSize !== null && pageSize !== void 0 ? pageSize : DefaultPagination.pageSize
  });
  const {
    columns,
    browserFields,
    isBrowserFieldDataLoading,
    onToggleColumn,
    onResetColumns,
    visibleColumns,
    onChangeVisibleColumns,
    onColumnResize,
    fields
  } = (0, _use_columns.useColumns)({
    featureIds,
    storageAlertsTable,
    storage,
    id,
    defaultColumns: columnConfigByClient,
    initialBrowserFields: propBrowserFields
  });
  const onPageChange = (0, _react.useCallback)(_pagination => {
    setPagination(_pagination);
  }, []);
  const [isLoading, {
    alerts,
    oldAlertsData,
    ecsAlertsData,
    isInitializing,
    getInspectQuery,
    refetch: refresh,
    totalAlerts: alertsCount,
    updatedAt
  }] = (0, _use_fetch_alerts.useFetchAlerts)({
    fields,
    featureIds,
    query,
    pagination,
    onPageChange,
    onLoaded,
    runtimeMappings,
    sort,
    skip: false
  });
  const {
    data: mutedAlerts
  } = (0, _use_get_muted_alerts.useGetMutedAlerts)([...new Set(alerts.map(a => a['kibana.alert.rule.uuid'][0]))]);
  (0, _react.useEffect)(() => {
    alertsTableConfigurationRegistry.update(configurationId, {
      ...alertsTableConfiguration,
      actions: {
        toggleColumn: onToggleColumn
      }
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [onToggleColumn]);
  (0, _react.useEffect)(() => {
    if (onUpdate) {
      onUpdate({
        isLoading,
        totalCount: alertsCount,
        refresh
      });
    }
  }, [isLoading, alertsCount, onUpdate, refresh]);
  (0, _react.useEffect)(() => {
    if (lastReloadRequestTime) {
      refresh();
    }
  }, [lastReloadRequestTime, refresh]);
  const caseIds = (0, _react.useMemo)(() => getCaseIdsFromAlerts(alerts), [alerts]);
  const maintenanceWindowIds = (0, _react.useMemo)(() => getMaintenanceWindowIdsFromAlerts(alerts), [alerts]);
  const casesPermissions = casesService === null || casesService === void 0 ? void 0 : casesService.helpers.canUseCases((_alertsTableConfigura6 = alertsTableConfiguration === null || alertsTableConfiguration === void 0 ? void 0 : (_alertsTableConfigura7 = alertsTableConfiguration.cases) === null || _alertsTableConfigura7 === void 0 ? void 0 : _alertsTableConfigura7.owner) !== null && _alertsTableConfigura6 !== void 0 ? _alertsTableConfigura6 : []);
  const hasCaseReadPermissions = Boolean(casesPermissions === null || casesPermissions === void 0 ? void 0 : casesPermissions.read);
  const fetchCases = isCasesColumnEnabled(columns) && hasCaseReadPermissions;
  const fetchMaintenanceWindows = isMaintenanceWindowColumnEnabled(columns);
  const {
    data: cases,
    isFetching: isLoadingCases
  } = (0, _use_bulk_get_cases.useBulkGetCases)(Array.from(caseIds.values()), fetchCases);
  const {
    data: maintenanceWindows,
    isFetching: isLoadingMaintenanceWindows
  } = (0, _use_bulk_get_maintenance_windows.useBulkGetMaintenanceWindows)({
    ids: Array.from(maintenanceWindowIds.values()),
    canFetchMaintenanceWindows: fetchMaintenanceWindows,
    queryContext: _alerts_table_context.AlertsTableQueryContext
  });
  const initialBulkActionsState = (0, _react.useReducer)(_reducer.bulkActionsReducer, {
    rowSelection: new Map(),
    isAllSelected: false,
    areAllVisibleRowsSelected: false,
    rowCount: alerts.length
  });
  const onSortChange = (0, _react.useCallback)(_sort => {
    const newSort = _sort.map(sortItem => {
      return {
        [sortItem.id]: {
          order: sortItem.direction
        }
      };
    });
    storageAlertsTable.current = {
      ...storageAlertsTable.current,
      sort: newSort
    };
    storage.current.set(id, storageAlertsTable.current);
    setSort(newSort);
  }, [id]);
  const useFetchAlertsData = (0, _react.useCallback)(() => {
    return {
      activePage: pagination.pageIndex,
      alerts,
      alertsCount,
      isInitializing,
      isLoading,
      getInspectQuery,
      onPageChange,
      onSortChange,
      refresh,
      sort,
      updatedAt,
      oldAlertsData,
      ecsAlertsData
    };
  }, [alerts, alertsCount, ecsAlertsData, getInspectQuery, isInitializing, isLoading, oldAlertsData, onPageChange, onSortChange, pagination, refresh, sort, updatedAt]);
  const CasesContext = casesService === null || casesService === void 0 ? void 0 : casesService.ui.getCasesContext();
  const isCasesContextAvailable = casesService && CasesContext;
  const memoizedCases = (0, _react.useMemo)(() => ({
    data: cases !== null && cases !== void 0 ? cases : new Map(),
    isLoading: isLoadingCases
  }), [cases, isLoadingCases]);
  const memoizedMaintenanceWindows = (0, _react.useMemo)(() => ({
    data: maintenanceWindows !== null && maintenanceWindows !== void 0 ? maintenanceWindows : new Map(),
    isLoading: isLoadingMaintenanceWindows
  }), [maintenanceWindows, isLoadingMaintenanceWindows]);
  const tableProps = (0, _react.useMemo)(() => ({
    alertsTableConfiguration,
    cases: memoizedCases,
    maintenanceWindows: memoizedMaintenanceWindows,
    columns,
    bulkActions: [],
    deletedEventIds: [],
    disabledCellActions: [],
    pageSize: pagination.pageSize,
    pageSizeOptions: [10, 20, 50, 100],
    id,
    leadingControlColumns: leadingControlColumns !== null && leadingControlColumns !== void 0 ? leadingControlColumns : [],
    showAlertStatusWithFlapping,
    trailingControlColumns: [],
    useFetchAlertsData,
    visibleColumns,
    'data-test-subj': 'internalAlertsState',
    updatedAt,
    browserFields,
    onToggleColumn,
    onResetColumns,
    onChangeVisibleColumns,
    onColumnResize,
    query,
    rowHeightsOptions,
    renderCellValue,
    gridStyle,
    controls: persistentControls,
    showInspectButton,
    toolbarVisibility,
    shouldHighlightRow,
    dynamicRowHeight,
    featureIds
  }), [alertsTableConfiguration, memoizedCases, memoizedMaintenanceWindows, columns, pagination.pageSize, id, leadingControlColumns, showAlertStatusWithFlapping, useFetchAlertsData, visibleColumns, updatedAt, browserFields, onToggleColumn, onResetColumns, onChangeVisibleColumns, onColumnResize, query, rowHeightsOptions, renderCellValue, gridStyle, persistentControls, showInspectButton, toolbarVisibility, shouldHighlightRow, dynamicRowHeight, featureIds]);
  return hasAlertsTableConfiguration ? /*#__PURE__*/_react.default.createElement(_alerts_table_context.AlertsTableContext.Provider, {
    value: {
      mutedAlerts: mutedAlerts !== null && mutedAlerts !== void 0 ? mutedAlerts : {},
      bulkActions: initialBulkActionsState
    }
  }, !isLoading && alertsCount === 0 && /*#__PURE__*/_react.default.createElement(_inspect.InspectButtonContainer, null, /*#__PURE__*/_react.default.createElement(_empty_state.EmptyState, {
    controls: persistentControls,
    getInspectQuery: getInspectQuery,
    showInpectButton: showInspectButton
  })), (isLoading || isBrowserFieldDataLoading) && /*#__PURE__*/_react.default.createElement(_eui.EuiProgress, {
    size: "xs",
    color: "accent",
    "data-test-subj": "internalAlertsPageLoading"
  }), alertsCount !== 0 && isCasesContextAvailable && /*#__PURE__*/_react.default.createElement(CasesContext, {
    owner: (_alertsTableConfigura8 = (_alertsTableConfigura9 = alertsTableConfiguration.cases) === null || _alertsTableConfigura9 === void 0 ? void 0 : _alertsTableConfigura9.owner) !== null && _alertsTableConfigura8 !== void 0 ? _alertsTableConfigura8 : [],
    permissions: casesPermissions,
    features: {
      alerts: {
        sync: (_alertsTableConfigura10 = (_alertsTableConfigura11 = alertsTableConfiguration.cases) === null || _alertsTableConfigura11 === void 0 ? void 0 : _alertsTableConfigura11.syncAlerts) !== null && _alertsTableConfigura10 !== void 0 ? _alertsTableConfigura10 : false
      }
    }
  }, /*#__PURE__*/_react.default.createElement(_alerts_table.AlertsTable, tableProps)), alertsCount !== 0 && !isCasesContextAvailable && /*#__PURE__*/_react.default.createElement(_alerts_table.AlertsTable, tableProps)) : /*#__PURE__*/_react.default.createElement(_eui.EuiEmptyPrompt, {
    "data-test-subj": "alertsTableNoConfiguration",
    iconType: "watchesApp",
    title: /*#__PURE__*/_react.default.createElement("h2", null, _translations.ALERTS_TABLE_CONF_ERROR_TITLE),
    body: /*#__PURE__*/_react.default.createElement("p", null, _translations.ALERTS_TABLE_CONF_ERROR_MESSAGE)
  });
};

// eslint-disable-next-line import/no-default-export