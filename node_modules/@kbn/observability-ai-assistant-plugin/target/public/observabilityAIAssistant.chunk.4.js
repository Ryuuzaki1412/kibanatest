/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.observabilityAIAssistant_bundle_jsonpfunction=window.observabilityAIAssistant_bundle_jsonpfunction||[]).push([[4],{113:function(e,n,t){"use strict";t.r(n),t.d(n,"createChatService",(function(){return u}));var o=t(42),r=t(26),s=t(30),a=t(56),i=t(4);class TokenLimitReachedError extends Error{constructor(){super("Token limit reached")}}class ServerError extends Error{}const c=35;function l(e){var n,t;const o=null===(n=e.response)||void 0===n?void 0:n.status;var r;if(!o||o>=400)throw new Error((null===(r=e.response)||void 0===r?void 0:r.statusText)||"Unexpected error");const a=null===(t=e.response.body)||void 0===t?void 0:t.getReader();if(!a)throw new Error("Could not get reader from response");return(i=a,new s.Observable((e=>{let n="";return async function t(){const{done:o,value:r}=await i.read();if(o)return n&&e.next(n),void e.complete();const s=(new TextDecoder).decode(r).split("\n");s[0]=n+s[0],n=s.pop()||"";for(const n of s)e.next(n);return t()}().catch((n=>e.error(n))),()=>{i.cancel().catch((()=>{}))}})).pipe(Object(s.share)())).pipe(Object(s.timestamp)(),Object(s.scan)(((e,n)=>{const t=e.timestamp||0;return{timestamp:Math.max(t+c,n.timestamp),value:n.value}})),Object(s.concatMap)((e=>{const n=Date.now(),t=e.timestamp-n;return t<=0?Object(s.of)(e.value):Object(s.of)(e.value).pipe(Object(s.delay)(t))})));var i}async function u({analytics:e,signal:n,registrations:t,client:c}){const u=new Map,d=new Map,[{functionDefinitions:p,contextDefinitions:m}]=await Promise.all([c("GET /internal/observability_ai_assistant/functions",{signal:n}),...t.map((e=>e({registerRenderFunction:(e,n)=>{d.set(e,n)}})))]);p.forEach((e=>{u.set(e.name,e)}));const b=e=>function({contexts:e,filter:n,definitions:t}){return e||n?t.filter((t=>{const o=!e||t.contexts.some((n=>e.includes(n))),r=!n||t.name.includes(n)||t.description.includes(n);return o&&r})):t}({...e,definitions:p});return{analytics:e,renderFunction:(e,n,t)=>{var o,r;const s=d.get(e);if(!s)throw new Error(`Function ${e} not found`);const a=n?JSON.parse(n):{},i={content:JSON.parse(null!==(o=t.content)&&void 0!==o?o:"{}"),data:JSON.parse(null!==(r=t.data)&&void 0!==r?r:"{}")};return null==s?void 0:s({response:i,arguments:a})},getContexts:()=>m,getFunctions:b,hasFunction:e=>u.has(e),hasRenderFunction:e=>d.has(e),complete({connectorId:e,messages:n,conversationId:t,persist:o,signal:r}){const i=new s.Subject;return c("POST /internal/observability_ai_assistant/chat/complete",{params:{body:{messages:n,connectorId:e,conversationId:t,persist:o}},signal:r,asResponse:!0,rawResponse:!0}).then((e=>{const n=l(e).pipe(Object(s.map)((e=>JSON.parse(e))),Object(s.tap)((e=>{if(e.type===a.c.ConversationCompletionError){var n;const t=null!==(n=e.error.code)&&void 0!==n?n:a.a.InternalError,o=e.error.message;throw new a.b(t,o)}}))).subscribe(i);r.addEventListener("abort",(()=>{n.unsubscribe()}))})).catch((e=>{i.error(e),i.complete()})),i},chat({connectorId:e,messages:n,function:t="auto"}){const a=new s.BehaviorSubject({message:{role:i.c.Assistant}}),u=b({contexts:["core","apm"]}),d=new AbortController;return c("POST /internal/observability_ai_assistant/chat",{params:{body:{messages:n,connectorId:e,functions:"none"===t?[]:u.filter((e=>e.visibility!==i.a.User)).map((e=>Object(r.pick)(e,"name","description","parameters")))}},signal:d.signal,asResponse:!0,rawResponse:!0}).then((e=>{const n=l(e).pipe((e=>e.pipe(Object(s.map)((e=>e.substring(6))),Object(s.filter)((e=>!!e&&"[DONE]"!==e)),Object(s.map)((e=>JSON.parse(e))),Object(s.tap)((e=>{if("error"in e)throw new ServerError(e.error.message);if("choices"in e&&e.choices.length&&"length"===e.choices[0].finish_reason)throw new TokenLimitReachedError})),Object(s.filter)((e=>"object"in e&&"chat.completion.chunk"===e.object)))),Object(s.scan)(((e,{choices:n})=>{var t,o,s,a,i;return e.message.content+=null!==(t=n[0].delta.content)&&void 0!==t?t:"",e.message.function_call.name+=null!==(o=null===(s=n[0].delta.function_call)||void 0===s?void 0:s.name)&&void 0!==o?o:"",e.message.function_call.arguments+=null!==(a=null===(i=n[0].delta.function_call)||void 0===i?void 0:i.arguments)&&void 0!==a?a:"",Object(r.cloneDeep)(e)}),{message:{content:"",function_call:{name:"",arguments:"",trigger:i.c.Assistant},role:i.c.Assistant}}),Object(s.catchError)((e=>Object(s.of)({...a.value,error:e,aborted:e instanceof o.AbortError||d.signal.aborted})))).subscribe(a);d.signal.addEventListener("abort",(()=>{n.unsubscribe(),a.next({...a.value,aborted:!0}),a.complete()}))})).catch((async e=>{if("response"in e){var n;const t=await(null===(n=e.response)||void 0===n?void 0:n.json());e.body=t,t.message&&(e.message=t.message)}throw e})).catch((e=>{a.next({...a.value,aborted:!1,error:e}),a.complete()})),a.pipe(Object(s.shareReplay)(1),Object(s.finalize)((()=>{d.abort()})))}}}},56:function(e,n,t){"use strict";t.d(n,"c",(function(){return s})),t.d(n,"a",(function(){return a})),t.d(n,"b",(function(){return ConversationCompletionError}));var o=t(6),r=t.n(o);let s,a;t(5),function(e){e.ChatCompletionChunk="chatCompletionChunk",e.ConversationCreate="conversationCreate",e.ConversationUpdate="conversationUpdate",e.MessageAdd="messageAdd",e.ConversationCompletionError="conversationCompletionError"}(s||(s={})),function(e){e.InternalError="internalError",e.NotFound="notFound"}(a||(a={}));class ConversationCompletionError extends Error{constructor(e,n){super(n),r()(this,"code",void 0),this.code=e}}}}]);