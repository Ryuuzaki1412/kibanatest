/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.observabilityAIAssistant_bundle_jsonpfunction=window.observabilityAIAssistant_bundle_jsonpfunction||[]).push([[3],{106:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i(19),n=i(0),r=a.__importDefault(i(107));t.default=function(e,t){void 0===t&&(t=[]);var i=r.default(e,t,{loading:!0}),a=i[0],s=i[1];return n.useEffect((function(){s()}),[s]),a}},107:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i(19),n=i(0),r=a.__importDefault(i(108));t.default=function(e,t,i){void 0===t&&(t=[]),void 0===i&&(i={loading:!1});var s=n.useRef(0),l=r.default(),o=n.useState(i),u=o[0],c=o[1],d=n.useCallback((function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var n=++s.current;return c((function(e){return a.__assign(a.__assign({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return l()&&n===s.current&&c({value:e,loading:!1}),e}),(function(e){return l()&&n===s.current&&c({error:e,loading:!1}),e}))}),t);return[u,d]}},108:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i(0);t.default=function(){var e=a.useRef(!1),t=a.useCallback((function(){return e.current}),[]);return a.useEffect((function(){return e.current=!0,function(){e.current=!1}})),t}},111:function(e,t,i){"use strict";i.r(t),i.d(t,"registerFunctions",(function(){return j}));var a=i(2),n=i.n(a),r=i(12),s=i(5),l=i(6),o=i.n(l);const u="layer",c="infra_lens_ad_hoc_default",d=10;function v(e){return null!=e}const g=({columnName:e,options:t})=>{var i,a;const{interval:n="auto",...r}=null!==(i=null==t?void 0:t.params)&&void 0!==i?i:{};return{[e]:{dataType:"date",isBucketed:!0,label:"@timestamp",operationType:"date_histogram",scale:"interval",sourceField:null!==(a=null==t?void 0:t.sourceField)&&void 0!==a?a:"@timestamp",params:{interval:n,...r}}}},h=({columnName:e,field:t,options:i})=>{const{size:a=d,...n}=null!=i?i:{};return{[e]:{label:`Top ${a} values of ${t}`,dataType:"string",operationType:"terms",scale:"ordinal",sourceField:t,isBucketed:!0,params:{size:a,orderBy:{type:"alphabetical",fallback:!1},orderDirection:"asc",otherBucket:!1,missingBucket:!1,parentFormat:{id:"terms"},include:[],exclude:[],includeIsRegex:!1,excludeIsRegex:!1,...n}}}},f="formula_accessor";class xy_chart_XYChart{constructor(e){o()(this,"_layers",null),this.chartConfig=e}getVisualizationType(){return"lnsXY"}get layers(){return this._layers||(this._layers=Array.isArray(this.chartConfig.layers)?this.chartConfig.layers:[this.chartConfig.layers]),this._layers}getLayers(){return this.layers.reduce(((e,t,i)=>{const a=`${u}_${i}`,n=`${f}_${i}`;return{...e,...t.getLayer(a,n,this.chartConfig.dataView,this.chartConfig.formulaAPI)}}),{})}getVisualizationState(){var e,t,i,a,n,r,s,l,o,c,d;return{...p({layers:[...this.chartConfig.layers.map(((e,t)=>{const i=`${u}_${t}`,a=`${f}_${t}`;return e.getLayerConfig(i,a)}))]}),legend:null!==(e=null===(t=this.chartConfig.visualOptions)||void 0===t?void 0:t.legend)&&void 0!==e?e:{isVisible:!1,position:"right",showSingleSeries:!1},fittingFunction:null!==(i=null===(a=this.chartConfig.visualOptions)||void 0===a?void 0:a.missingValues)&&void 0!==i?i:"None",endValue:null===(n=this.chartConfig.visualOptions)||void 0===n?void 0:n.endValues,curveType:null===(r=this.chartConfig.visualOptions)||void 0===r?void 0:r.lineInterpolation,emphasizeFitting:!(null!==(s=this.chartConfig.visualOptions)&&void 0!==s&&s.showDottedLine),valueLabels:null===(l=this.chartConfig.visualOptions)||void 0===l?void 0:l.valueLabels,axisTitlesVisibilitySettings:null!==(o=null===(c=this.chartConfig.visualOptions)||void 0===c?void 0:c.axisTitlesVisibilitySettings)&&void 0!==o?o:{x:!1,yLeft:!1,yRight:!0},yLeftExtent:null===(d=this.chartConfig.visualOptions)||void 0===d?void 0:d.yLeftExtent}}getReferences(){return this.layers.flatMap(((e,t)=>{const i=`${u}_${t}`;return e.getReference(i,this.chartConfig.dataView)}))}getDataViews(){return[this.chartConfig.dataView,...this.chartConfig.layers.map((e=>e.getDataView())).filter((e=>!!e))]}getTitle(){var e,t;return null!==(e=null!==(t=this.chartConfig.title)&&void 0!==t?t:this.layers[0].getName())&&void 0!==e?e:""}}const p=e=>({legend:{isVisible:!1,position:"right",showSingleSeries:!1},valueLabels:"show",yLeftScale:"linear",tickLabelsVisibilitySettings:{x:!0,yLeft:!0,yRight:!0},labelsOrientation:{x:0,yLeft:0,yRight:0},gridlinesVisibilitySettings:{x:!0,yLeft:!0,yRight:!0},preferredSeriesType:"line",valuesInLegend:!1,hideEndzones:!0,...e});class FormulaColumn{constructor(e){this.valueConfig=e}getValueConfig(){return this.valueConfig}getData(e,t,i,a){const{value:n,...r}=this.getValueConfig(),s=a.insertOrReplaceFormulaColumn(e,{formula:n,...r},t,i);if(!s)throw new Error("Error generating the data layer for the chart");return s}}const y="aggs_breakdown",_="x_date_histogram";class xy_data_layer_XYDataLayer{constructor(e){var t,i;o()(this,"column",void 0),o()(this,"layerConfig",void 0),this.column=e.data.map((e=>new FormulaColumn(e))),this.layerConfig={...e,layerType:null!==(t=e.layerType)&&void 0!==t?t:"data",options:{...e.options,buckets:{type:"date_histogram",...null===(i=e.options)||void 0===i?void 0:i.buckets}}}}getName(){return this.column[0].getValueConfig().label}getBaseLayer(e,t){var i,a,n;return{..."date_histogram"===(null===(i=t.buckets)||void 0===i?void 0:i.type)?g({columnName:_,options:{params:{...t.buckets.params},sourceField:null!==(a=t.buckets.field)&&void 0!==a?a:e.timeFieldName}}):{},..."top_values"===(null===(n=t.breakdown)||void 0===n?void 0:n.type)?{...h({columnName:y,field:null==t?void 0:t.breakdown.field,options:{...t.breakdown.params}})}:{}}}getLayer(e,t,i,a){var n,r,s,l,o,u;const c=[];"top_values"===(null===(n=this.layerConfig.options)||void 0===n||null===(r=n.breakdown)||void 0===r?void 0:r.type)&&c.push(y),"date_histogram"===(null===(s=this.layerConfig.options)||void 0===s||null===(l=s.buckets)||void 0===l?void 0:l.type)&&c.push(_);const d={columnOrder:c,columns:{...this.getBaseLayer(null!==(o=this.layerConfig.dataView)&&void 0!==o?o:i,null!==(u=this.layerConfig.options)&&void 0!==u?u:{})}};return{[e]:this.column.reduce(((e,n,r)=>{var s;return{...e,...n.getData(`${t}_${r}`,e,null!==(s=this.layerConfig.dataView)&&void 0!==s?s:i,a)}}),d)}}getReference(e,t){var i,a,n,r;return a=null!==(i=this.layerConfig.dataView)&&void 0!==i?i:t,n=e,[{type:"index-pattern",id:null!==(r=a.id)&&void 0!==r?r:c,name:`indexpattern-datasource-layer-${n}`}]}getLayerConfig(e,t){var i,a,n,r,s,l;return{layerId:e,seriesType:null!==(i=null===(a=this.layerConfig.options)||void 0===a?void 0:a.seriesType)&&void 0!==i?i:"line",accessors:this.column.map(((e,i)=>`${t}_${i}`)),yConfig:this.layerConfig.data.map((({color:e},i)=>e?{forAccessor:`${t}_${i}`,color:e}:void 0)).filter(v),layerType:"data",xAccessor:"date_histogram"===(null===(n=this.layerConfig.options)||void 0===n||null===(r=n.buckets)||void 0===r?void 0:r.type)?_:void 0,splitAccessor:"top_values"===(null===(s=this.layerConfig.options)||void 0===s||null===(l=s.breakdown)||void 0===l?void 0:l.type)?y:void 0}}getDataView(){return this.layerConfig.dataView}}class data_view_cache_DataViewCache{constructor(e){o()(this,"cache",new Map),o()(this,"capacity",void 0),this.capacity=e,this.cache=new Map}static getInstance(e=10){return data_view_cache_DataViewCache.instance||(data_view_cache_DataViewCache.instance=new data_view_cache_DataViewCache(e)),data_view_cache_DataViewCache.instance}getSpec(e){var t;const i=null!==(t=e.id)&&void 0!==t?t:"lens_ad_hoc_default",a=this.cache.get(i);if(!a){const t=e.toSpec();return this.setSpec(i,t),t}return a}setSpec(e,t){if(this.cache.size>=this.capacity){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(e,t)}}o()(data_view_cache_DataViewCache,"instance",void 0);class lens_attributes_builder_LensAttributesBuilder{constructor(e){o()(this,"dataViewCache",void 0),this.lens=e,this.dataViewCache=data_view_cache_DataViewCache.getInstance()}build(){const{visualization:e}=this.lens;return{title:e.getTitle(),visualizationType:e.getVisualizationType(),references:e.getReferences(),state:{datasourceStates:{formBased:{layers:e.getLayers()}},internalReferences:e.getReferences(),filters:[],query:{language:"kuery",query:""},visualization:e.getVisualizationState(),adHocDataViews:(t=e.getDataViews().reduce(((e,t)=>({...e,...this.dataViewCache.getSpec(t)})),{}),{[null!==(i=t.id)&&void 0!==i?i:c]:{...t}})}};var t,i}}var m=i(0),b=i.n(m),C=i(106),w=i.n(C),x=i(1);let V;function k({indexPattern:e,xyDataLayer:t,start:i,end:a,lens:l,dataViews:o,timeField:u}){const c=w()((()=>l.stateHelperApi()),[l]),d=w()((()=>o.create({title:e,timeFieldName:u})),[e]),[v,g]=Object(m.useState)(!1);if(!c.value||!d.value)return Object(x.jsx)(r.EuiLoadingSpinner,null);const h=new lens_attributes_builder_LensAttributesBuilder({visualization:new xy_chart_XYChart({layers:[t],formulaAPI:c.value.formula,dataView:d.value})}).build(),f={id:e,attributes:h,timeRange:{from:i,to:a,mode:"relative"}};return Object(x.jsx)(b.a.Fragment,null,Object(x.jsx)(r.EuiFlexGroup,{direction:"column"},Object(x.jsx)(r.EuiFlexItem,{grow:!1},Object(x.jsx)(r.EuiFlexGroup,{direction:"row",gutterSize:"s",justifyContent:"flexEnd"},Object(x.jsx)(r.EuiFlexItem,{grow:!1},Object(x.jsx)(r.EuiButton,{"data-test-subj":"observabilityAiAssistantLensOpenInLensButton",iconType:"lensApp",onClick:()=>{l.navigateToPrefilledEditor(f)}},s.i18n.translate("xpack.observabilityAiAssistant.lensFunction.openInLens",{defaultMessage:"Open in Lens"}))),Object(x.jsx)(r.EuiFlexItem,{grow:!1},Object(x.jsx)(r.EuiButton,{"data-test-subj":"observabilityAiAssistantLensSaveButton",iconType:"save",onClick:()=>{g((()=>!0))}},s.i18n.translate("xpack.observabilityAiAssistant.lensFunction.save",{defaultMessage:"Save"}))))),Object(x.jsx)(r.EuiFlexItem,null,Object(x.jsx)(l.EmbeddableComponent,n()({},f,{style:{height:240}})))),v?Object(x.jsx)(l.SaveModalComponent,{initialInput:f,onClose:()=>{g((()=>!1))}}):null)}async function j({registerRenderFunction:e,service:t,pluginsStart:i}){!function({service:e,registerRenderFunction:t,pluginsStart:i}){t("lens",(({arguments:{layers:e,indexPattern:t,breakdown:a,seriesType:n,start:r,end:s,timeField:l}})=>{const o=new xy_data_layer_XYDataLayer({data:e.map((e=>{var t;return{type:"formula",value:e.formula,label:e.label,format:e.format,filter:{language:"kql",query:null!==(t=e.filter)&&void 0!==t?t:""}}})),options:{seriesType:n,breakdown:a?{type:"top_values",params:{size:10},field:a.field}:void 0}});if(l)return Object(x.jsx)(k,{indexPattern:t,xyDataLayer:o,start:r,end:s,lens:i.lens,dataViews:i.dataViews,timeField:l})}))}({service:t,pluginsStart:i,registerRenderFunction:e})}!function(e){e.Bar="bar",e.Line="line",e.Area="area",e.BarStacked="bar_stacked",e.AreaStacked="area_stacked",e.BarHorizontal="bar_horizontal",e.BarPercentageStacked="bar_percentage_stacked",e.AreaPercentageStacked="area_percentage_stacked",e.BarHorizontalPercentageStacked="bar_horizontal_percentage_stacked"}(V||(V={}))}}]);