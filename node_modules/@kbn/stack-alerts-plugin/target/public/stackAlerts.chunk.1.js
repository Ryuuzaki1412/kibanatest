/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.stackAlerts_bundle_jsonpfunction=window.stackAlerts_bundle_jsonpfunction||[]).push([[1],{32:function(e,t,s){"use strict";var r,a=function(){var e={};return function(t){if(void 0===e[t]){var s=document.querySelector(t);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}e[t]=s}return e[t]}}(),i=[];function l(e){for(var t=-1,s=0;s<i.length;s++)if(i[s].identifier===e){t=s;break}return t}function o(e,t){for(var s={},r=[],a=0;a<e.length;a++){var o=e[a],n=t.base?o[0]+t.base:o[0],u=s[n]||0,c="".concat(n," ").concat(u);s[n]=u+1;var d=l(c),p={css:o[1],media:o[2],sourceMap:o[3]};-1!==d?(i[d].references++,i[d].updater(p)):i.push({identifier:c,updater:j(p,t),references:1}),r.push(c)}return r}function n(e){var t=document.createElement("style"),r=e.attributes||{};if(void 0===r.nonce){var i=s.nc;i&&(r.nonce=i)}if(Object.keys(r).forEach((function(e){t.setAttribute(e,r[e])})),"function"==typeof e.insert)e.insert(t);else{var l=a(e.insert||"head");if(!l)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");l.appendChild(t)}return t}var u,c=(u=[],function(e,t){return u[e]=t,u.filter(Boolean).join("\n")});function d(e,t,s,r){var a=s?"":r.media?"@media ".concat(r.media," {").concat(r.css,"}"):r.css;if(e.styleSheet)e.styleSheet.cssText=c(t,a);else{var i=document.createTextNode(a),l=e.childNodes;l[t]&&e.removeChild(l[t]),l.length?e.insertBefore(i,l[t]):e.appendChild(i)}}function p(e,t,s){var r=s.css,a=s.media,i=s.sourceMap;if(a?e.setAttribute("media",a):e.removeAttribute("media"),i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),e.styleSheet)e.styleSheet.cssText=r;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(r))}}var g=null,b=0;function j(e,t){var s,r,a;if(t.singleton){var i=b++;s=g||(g=n(t)),r=d.bind(null,s,i,!1),a=d.bind(null,s,i,!0)}else s=n(t),r=p.bind(null,s,t),a=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(s)};return r(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;r(e=t)}else a()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=(void 0===r&&(r=Boolean(window&&document&&document.all&&!window.atob)),r));var s=o(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var r=0;r<s.length;r++){var a=l(s[r]);i[a].references--}for(var n=o(e,t),u=0;u<s.length;u++){var c=l(s[u]);0===i[c].references&&(i[c].updater(),i.splice(c,1))}s=n}}}},33:function(e,t,s){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var s=function(e,t){var s,r,a,i=e[1]||"",l=e[3];if(!l)return i;if(t&&"function"==typeof btoa){var o=(s=l,r=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),a="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),"/*# ".concat(a," */")),n=l.sources.map((function(e){return"/*# sourceURL=".concat(l.sourceRoot||"").concat(e," */")}));return[i].concat(n).concat([o]).join("\n")}return[i].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(s,"}"):s})).join("")},t.i=function(e,s,r){"string"==typeof e&&(e=[[null,e,""]]);var a={};if(r)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(a[l]=!0)}for(var o=0;o<e.length;o++){var n=[].concat(e[o]);r&&a[n[0]]||(s&&(n[2]?n[2]="".concat(s," and ").concat(n[2]):n[2]=s),t.push(n))}},t}},34:function(e,t,s){e.exports=s(21)(3)},35:function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var r=s(2),a=s(0),i=s(7),l=s(10),o=s(4),n=s(19),u=s(1),c=s(3);const d=({index:e,esFields:t,timeField:s,errors:d,onIndexChange:p,onTimeFieldChange:g})=>{const{http:b}=Object(n.useKibana)().services,[j,m]=Object(r.useState)(!1),[h,y]=Object(r.useState)([]),[x,O]=Object(r.useState)(!1),[f,E]=Object(r.useState)([u.firstFieldOption]),S=Object(i.debounce)((async e=>{O(!0),y(await Object(u.getIndexOptions)(b,e)),O(!1)}),250);Object(r.useEffect)((()=>{const e=Object(u.getTimeFieldOptions)(t);E([u.firstFieldOption,...e])}),[t]);const T=()=>{m(!1),void 0===s&&g("")};return Object(c.jsx)(o.EuiPopover,{id:"indexPopover",button:Object(c.jsx)(o.EuiExpression,{display:"columns","data-test-subj":"selectIndexExpression",description:a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexLabel",{defaultMessage:"index"}),value:e&&e.length>0?(e=>{const t=e.map(((t,s)=>Object(c.jsx)("p",{key:s},t,s<e.length-1?",":null)));return Object(c.jsx)("div",null,t)})(e):a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexPlaceholder",{defaultMessage:"Select indices and a time field"}),isActive:j,onClick:()=>{m(!0)},isInvalid:!(e&&e.length>0&&""!==s)}),isOpen:j,closePopover:T,ownFocus:!0,anchorPosition:"downLeft",zIndex:8e3,display:"block"},Object(c.jsx)("div",{style:{width:"450px"}},Object(c.jsx)(o.EuiPopoverTitle,null,Object(c.jsx)(o.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(c.jsx)(o.EuiFlexItem,null,a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.indexButtonLabel",{defaultMessage:"index"})),Object(c.jsx)(o.EuiFlexItem,{grow:!1},Object(c.jsx)(o.EuiButtonIcon,{"data-test-subj":"closePopover",iconType:"cross",color:"danger","aria-label":a.i18n.translate("xpack.stackAlerts.components.ui.alertParams.closeIndexPopoverLabel",{defaultMessage:"Close"}),onClick:T})))),Object(c.jsx)(o.EuiFormRow,{id:"indexSelectSearchBox",fullWidth:!0,label:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.indicesToQueryLabel",defaultMessage:"Indices to query"}),isInvalid:d.index.length>0&&null!=e&&e.length>0,error:d.index,helpText:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.howToBroadenSearchQueryDescription",defaultMessage:"Use * to broaden your query."})},Object(c.jsx)(o.EuiComboBox,{fullWidth:!0,async:!0,isLoading:x,isInvalid:d.index.length>0&&null!=e&&e.length>0,noSuggestions:!h.length,options:h,"data-test-subj":"thresholdIndexesComboBox",selectedOptions:(e||[]).map((e=>({label:e,value:e}))),onChange:async e=>{const t=e.map((e=>e.value)).filter(i.isString);if(p(t),0===t.length)E([u.firstFieldOption]);else{const e=await Object(u.getFields)(b,t),s=Object(u.getTimeFieldOptions)(e);E([u.firstFieldOption,...s])}},onSearchChange:S,onBlur:()=>{e||p([])}})),Object(c.jsx)(o.EuiFormRow,{id:"thresholdTimeField",fullWidth:!0,label:Object(c.jsx)(l.FormattedMessage,{id:"xpack.stackAlerts.components.ui.alertParams.timeFieldLabel",defaultMessage:"Time field"}),isInvalid:d.timeField.length>0&&void 0!==s,error:d.timeField},Object(c.jsx)(o.EuiSelect,{options:f,isInvalid:d.timeField.length>0&&void 0!==s,fullWidth:!0,name:"thresholdTimeField","data-test-subj":"thresholdAlertTimeFieldSelect",value:s||"",onChange:e=>{g(e.target.value)},onBlur:()=>{void 0===s&&g("")}}))))}},36:function(e,t,s){"use strict";e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){if(t.constructor!==s.constructor)return!1;var r,a,i;if(Array.isArray(t)){if((r=t.length)!=s.length)return!1;for(a=r;0!=a--;)if(!e(t[a],s[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===s.source&&t.flags===s.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===s.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===s.toString();if((r=(i=Object.keys(t)).length)!==Object.keys(s).length)return!1;for(a=r;0!=a--;)if(!Object.prototype.hasOwnProperty.call(s,i[a]))return!1;for(a=r;0!=a--;){var l=i[a];if(!e(t[l],s[l]))return!1}return!0}return t!=t&&s!=s}},48:function(e,t){ace.define("ace/theme/github",["require","exports","module","ace/lib/dom"],(function(e,t,s){t.isDark=!1,t.cssClass="ace-github",t.cssText='.ace-github .ace_gutter {background: #e8e8e8;color: #AAA;}.ace-github  {background: #fff;color: #000;}.ace-github .ace_keyword {font-weight: bold;}.ace-github .ace_string {color: #D14;}.ace-github .ace_variable.ace_class {color: teal;}.ace-github .ace_constant.ace_numeric {color: #099;}.ace-github .ace_constant.ace_buildin {color: #0086B3;}.ace-github .ace_support.ace_function {color: #0086B3;}.ace-github .ace_comment {color: #998;font-style: italic;}.ace-github .ace_variable.ace_language  {color: #0086B3;}.ace-github .ace_paren {font-weight: bold;}.ace-github .ace_boolean {font-weight: bold;}.ace-github .ace_string.ace_regexp {color: #009926;font-weight: normal;}.ace-github .ace_variable.ace_instance {color: teal;}.ace-github .ace_constant.ace_language {font-weight: bold;}.ace-github .ace_cursor {color: black;}.ace-github.ace_focus .ace_marker-layer .ace_active-line {background: rgb(255, 255, 204);}.ace-github .ace_marker-layer .ace_active-line {background: rgb(245, 245, 245);}.ace-github .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-github.ace_multiselect .ace_selection.ace_start {box-shadow: 0 0 3px 0px white;}.ace-github.ace_nobold .ace_line > span {font-weight: normal !important;}.ace-github .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-github .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-github .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-github .ace_gutter-active-line {background-color : rgba(0, 0, 0, 0.07);}.ace-github .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-github .ace_invisible {color: #BFBFBF}.ace-github .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-github .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}',e("../lib/dom").importCssString(t.cssText,t.cssClass)}))},49:function(e,t,s){switch(window.__kbnThemeTag__){case"v8dark":return s(50);case"v8light":return s(52)}},50:function(e,t,s){var r=s(32),a=s(51);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[e.i,a,""]]);r(a,{insert:"head",singleton:!1}),e.exports=a.locals||{}},51:function(e,t,s){(t=s(33)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},52:function(e,t,s){var r=s(32),a=s(53);"string"==typeof(a=a.__esModule?a.default:a)&&(a=[[e.i,a,""]]);r(a,{insert:"head",singleton:!1}),e.exports=a.locals||{}},53:function(e,t,s){(t=s(33)(!1)).push([e.i,".searchSourceAlertFilters .euiExpression__value{width:80%}.dscExpressionParam.euiExpression{margin-left:0}",""]),e.exports=t},54:function(e,t,s){e.exports=s(21)(2)},56:function(e,t,s){"use strict";s.r(t);var r=s(34),a=s.n(r),i=s(2),l=s.n(i),o=s(36),n=s.n(o),u=(s(48),s(4)),c=s(0);let d;s(49),function(e){e.esQuery="esQuery",e.searchSource="searchSource",e.esqlQuery="esqlQuery"}(d||(d={}));var p=s(20),g=s(10),b=s(27),j=s(11),m=s(6),h=s(15),y=s(8),x=s(13),O=s(1);const f={result:null,error:null,isLoading:!1,rawResults:null,alerts:null};var E=s(3);const S={grid:{name:"q13xr8",styles:".euiDataGridHeaderCell{background:none;}.euiDataGridHeader .euiDataGridHeaderCell{border-top:none;}"}},T=({rawResults:e,alerts:t})=>Object(E.jsx)(u.EuiPanel,{style:{overflow:"hidden"},hasShadow:!1,hasBorder:!0},Object(E.jsx)(u.EuiDataGrid,{css:S.grid,"aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryTableAriaLabel",{defaultMessage:"Test query grid"}),"data-test-subj":"test-query-row-datagrid",columns:e.cols,columnVisibility:{visibleColumns:e.cols.map((e=>e.id)),setVisibleColumns:()=>{}},rowCount:e.rows.length,gridStyle:{border:"horizontal",rowHover:"none"},renderCellValue:({rowIndex:t,columnId:s})=>e.rows[t][s],pagination:{pageIndex:0,pageSize:10,onChangeItemsPerPage:()=>{},onChangePage:()=>{}},toolbarVisibility:!1}),Object(E.jsx)(u.EuiSpacer,{size:"m"}),t&&Object(E.jsx)(u.EuiFlexGroup,{gutterSize:"m"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiText,null,Object(E.jsx)("h5",null,c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryAlerts",{defaultMessage:"Alerts generated"})))),t.map(((e,t)=>Object(E.jsx)(u.EuiFlexItem,{key:t,grow:!1},Object(E.jsx)(u.EuiBadge,{"data-test-subj":"alert-badge",color:"primary"},e)))))),F=({fetch:e,copyQuery:t,hasValidationErrors:s,showTable:r})=>{const{onTestQuery:a,testQueryResult:o,testQueryError:n,testQueryLoading:d,testQueryRawResults:p,testQueryAlerts:b}=function(e){const[t,s]=Object(i.useState)(f);return Object(i.useEffect)((()=>{s(f)}),[e]),{onTestQuery:Object(i.useCallback)((async()=>{s({result:null,error:null,isLoading:!0,rawResults:null,alerts:null});try{const{testResults:r,isGrouped:a,timeWindow:i,rawResults:l}=await e();if(a)s({result:c.i18n.translate("xpack.stackAlerts.esQuery.ui.testQueryGroupedResponse",{defaultMessage:"Grouped query matched {groups} groups in the last {window}.",values:{groups:r.results.length,window:i}}),error:null,isLoading:!1,rawResults:null!=l?l:null,alerts:r.results.length>0?r.results.map((e=>e.group)):null});else{var t;const e=r.results.length>0?r.results[0]:{count:0};s({result:c.i18n.translate("xpack.stackAlerts.esQuery.ui.numQueryMatchesText",{defaultMessage:"Query matched {count} documents in the last {window}.",values:{count:null!==(t=null==e?void 0:e.count)&&void 0!==t?t:0,window:i}}),error:null,isLoading:!1,rawResults:null!=l?l:null,alerts:e.count>0?["query matched"]:null})}}catch(e){var r,a,i,l,o;const t=(null==e||null===(r=e.body)||void 0===r||null===(a=r.attributes)||void 0===a||null===(i=a.error)||void 0===i||null===(l=i.root_cause[0])||void 0===l?void 0:l.reason)||(null==e||null===(o=e.body)||void 0===o?void 0:o.message);s({result:null,error:c.i18n.translate("xpack.stackAlerts.esQuery.ui.queryError",{defaultMessage:"Error testing query: {message}",values:{message:t?`${e.message}: ${t}`:e.message}}),isLoading:!1,rawResults:null,alerts:null})}}),[e]),testQueryResult:t.result,testQueryError:t.error,testQueryLoading:t.isLoading,testQueryRawResults:t.rawResults,testQueryAlerts:t.alerts}}(e),[j,m]=Object(i.useState)(null);return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",responsive:!1,gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiButton,{"data-test-subj":"testQuery",color:"primary",iconSide:"left",iconType:"playFilled",onClick:()=>{a()},disabled:s,isLoading:d,size:"s"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQuery",defaultMessage:"Test query"}))),t&&Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiToolTip,{content:j,onMouseOut:()=>{m(null)}},Object(E.jsx)(u.EuiButtonEmpty,{"data-test-subj":"copyQuery",color:"primary",iconSide:"left",iconType:"copyClipboard",onClick:()=>{Object(u.copyToClipboard)(t())&&m(Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryCopiedToClipboard",defaultMessage:"Copied"}))},disabled:s,isLoading:d,size:"s"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.copyQuery",defaultMessage:"Copy query"})))))),d&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{color:"subdued",size:"s"},Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.testQueryIsExecuted",defaultMessage:"Query is executed."})))),o&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{"data-test-subj":"testQuerySuccess",color:"subdued",size:"s"},Object(E.jsx)("p",null,o))),n&&Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiText,{"data-test-subj":"testQueryError",color:"danger",size:"s"},Object(E.jsx)("p",null,n))),r&&p&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(T,{rawResults:p,alerts:b})))};var v=s(54),w=s.n(v);const C={name:"1y0ex1",styles:"max-width:400px"};class threshold_help_popover_QueryThresholdHelpPopover extends i.Component{constructor(...e){super(...e),w()(this,"state",{isPopoverOpen:!1}),w()(this,"PopoverStyles",{name:"1y0ex1",styles:"max-width:400px"}),w()(this,"_togglePopover",(()=>{this.setState((e=>({isPopoverOpen:!e.isPopoverOpen})))})),w()(this,"_closePopover",(()=>{this.setState({isPopoverOpen:!1})}))}_renderContent(){return Object(E.jsx)("div",{css:C},Object(E.jsx)(u.EuiText,{grow:!1,size:"s"},Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.threshold",defaultMessage:"Each time the rule runs, it checks whether the number of documents that match your query meets this threshold. If there is a grouped over clause, the rule checks the condition for the specified number of top groups."})),Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.timeWindow",defaultMessage:"The time window indicates how far back in time to search. To avoid gaps in detection, set this value greater than or equal to the value you chose for the {checkField} field.",values:{checkField:Object(E.jsx)("b",null,"Check every")}})),Object(E.jsx)("p",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.duplicateMatches",defaultMessage:"If {excludePrevious} is turned on, a document that matches the query in multiple runs will be used in only the first threshold calculation.",values:{excludePrevious:Object(E.jsx)("b",null,"Exclude matches from previous runs")}}))))}render(){return Object(E.jsx)(u.EuiPopover,{id:"thresholdHelpPopover","data-test-subj":"thresholdHelpPopover",anchorPosition:"upLeft",button:Object(E.jsx)(u.EuiButtonIcon,{onClick:this._togglePopover,iconType:"documentation","aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.thresholdHelp.ariaLabel",{defaultMessage:"Help"})}),isOpen:this.state.isPopoverOpen,closePopover:this._closePopover,repositionOnScroll:!0,ownFocus:!0},Object(E.jsx)(u.EuiPopoverTitle,null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.thresholdHelp.title",defaultMessage:"Set the group, threshold and time window"})),this._renderContent())}}const k=({esFields:e,thresholdComparator:t,threshold:s,timeWindowSize:r,timeWindowUnit:a,aggType:o,aggField:n,groupBy:d,termField:p,termSize:b,size:m,errors:h,hasValidationErrors:x,onChangeSelectedAggField:f,onChangeSelectedAggType:S,onChangeSelectedGroupBy:T,onChangeSelectedTermField:v,onChangeSelectedTermSize:w,onChangeThreshold:C,onChangeThresholdComparator:k,onChangeWindowSize:_,onChangeWindowUnit:A,onChangeSizeValue:R,onTestFetch:Q,onCopyQuery:I,excludeHitsFromPreviousRun:z,onChangeExcludeHitsFromPreviousRun:P,canSelectMultiTerms:M})=>{const[W,L]=Object(i.useState)(!1);return Object(i.useEffect)((()=>{d&&L(d!==j.builtInGroupByTypes.all.value)}),[d]),Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h4",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.conditionsPrompt",defaultMessage:"Set the group, threshold, and time window"})," ",Object(E.jsx)(threshold_help_popover_QueryThresholdHelpPopover,null))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(O.WhenExpression,{display:"fullWidth","data-test-subj":"whenExpression",aggType:null!=o?o:y.c.AGGREGATION_TYPE,onChangeSelectedAggType:S}),o&&O.builtInAggregationTypes[o].fieldRequired?Object(E.jsx)(O.OfExpression,{aggField:n,"data-test-subj":"aggTypeExpression",fields:e,aggType:o,errors:h,display:"fullWidth",onChangeSelectedAggField:f}):null,Object(E.jsx)(O.GroupByExpression,{groupBy:d||y.c.GROUP_BY,"data-test-subj":"groupByExpression",termField:p,termSize:b,errors:h,fields:e,display:"fullWidth",canSelectMultiTerms:M,onChangeSelectedGroupBy:T,onChangeSelectedTermField:v,onChangeSelectedTermSize:w}),Object(E.jsx)(O.ThresholdExpression,{"data-test-subj":"thresholdExpression",thresholdComparator:null!=t?t:y.c.THRESHOLD_COMPARATOR,threshold:null!=s?s:y.c.THRESHOLD,errors:h,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedThreshold:C,onChangeSelectedThresholdComparator:k}),Object(E.jsx)(O.ForLastExpression,{"data-test-subj":"forLastExpression",popupPosition:"upLeft",timeWindowSize:null!=r?r:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=a?a:y.c.TIME_WINDOW_UNIT,display:"fullWidth",errors:h,onChangeWindowSize:_,onChangeWindowUnit:A}),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",responsive:!1,gutterSize:"xs"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectSizePrompt",defaultMessage:"Set the number of documents to send"})))),Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiIconTip,{position:"right",color:"subdued",type:"questionInCircle",content:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectSizePrompt.toolTip",{defaultMessage:"Specify the number of documents to pass to the configured actions when the threshold condition is met."})}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(O.ValueExpression,{description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.sizeExpression",{defaultMessage:"Size"}),"data-test-subj":"sizeValueExpression",value:m,errors:h.size,display:"fullWidth",popupPosition:"upLeft",onChangeSelectedValue:R}),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(u.EuiFormRow,null,Object(E.jsx)(u.EuiCheckbox,{disabled:W,"data-test-subj":"excludeHitsFromPreviousRunExpression",checked:z,id:"excludeHitsFromPreviousRunExpressionId",onChange:e=>{P(e.target.checked)},label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.excludePreviousHitsExpression",{defaultMessage:"Exclude matches from previous runs"})})),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(F,{fetch:Q,copyQuery:I,hasValidationErrors:x}))};var _=s(5),A=s(12);const R=["pinFilter","disableFilter"],Q=e=>{var t,s,r,a,o,c,d,O,f;const S=Object(_.e)().unifiedSearch,{dataViews:T,dataViewEditor:F}=Object(_.e)(),{searchSource:v,errors:w,initialSavedQuery:C,setParam:Q,ruleParams:I}=e,[z,P]=Object(i.useState)();Object(i.useEffect)((()=>P(C)),[C]);const[M,W]=Object(i.useReducer)(((e,t)=>{var s;return(e=>"filter"===e.type||"index"===e.type||"query"===e.type)(t)?(v.setParent(void 0).setField(t.type,t.payload),Q("searchConfiguration",v.getSerializedFields()),"index"===t.type&&Q("timeField",null===(s=v.getField("index"))||void 0===s?void 0:s.timeFieldName)):Q(t.type,t.payload),{...e,[t.type]:t.payload}}),{index:v.getField("index"),query:v.getField("query"),filter:Object(b.mapAndFlattenFilters)(v.getField("filter")),threshold:null!==(t=I.threshold)&&void 0!==t?t:y.c.THRESHOLD,thresholdComparator:null!==(s=I.thresholdComparator)&&void 0!==s?s:y.c.THRESHOLD_COMPARATOR,timeWindowSize:null!==(r=I.timeWindowSize)&&void 0!==r?r:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!==(a=I.timeWindowUnit)&&void 0!==a?a:y.c.TIME_WINDOW_UNIT,aggType:null!==(o=I.aggType)&&void 0!==o?o:y.c.AGGREGATION_TYPE,aggField:I.aggField,groupBy:null!==(c=I.groupBy)&&void 0!==c?c:y.c.GROUP_BY,termSize:null!==(d=I.termSize)&&void 0!==d?d:y.c.TERM_SIZE,termField:I.termField,size:null!==(O=I.size)&&void 0!==O?O:y.c.SIZE,excludeHitsFromPreviousRun:null!==(f=I.excludeHitsFromPreviousRun)&&void 0!==f?f:y.c.EXCLUDE_PREVIOUS_HITS}),{index:L,query:q,filter:D}=M,B=Object(i.useMemo)((()=>L?[L]:[]),[L]),[H,U]=Object(i.useState)(L?Object(_.a)(L.fields.map((e=>e.toSpec()))):[]),G=Object(i.useCallback)((e=>{U(Object(_.a)(e.fields.map((e=>e.toSpec())))),W({type:"index",payload:e})}),[]),N=Object(i.useCallback)((e=>{W({type:"filter",payload:Object(b.mapAndFlattenFilters)(e)})}),[]),V=Object(i.useCallback)((({query:e})=>{n()(e,q)||W({type:"query",payload:e||{...q,query:""}})}),[q]),Y=Object(i.useCallback)((e=>{P(e);const t=e.attributes.filters;t&&W({type:"filter",payload:t})}),[]),Z=Object(i.useCallback)((e=>W({type:"timeWindowUnit",payload:e})),[]),J=Object(i.useCallback)((e=>e&&W({type:"timeWindowSize",payload:e})),[]),$=Object(i.useCallback)((e=>e&&W({type:"thresholdComparator",payload:e})),[]),X=Object(i.useCallback)((e=>W({type:"aggField",payload:e})),[]),K=Object(i.useCallback)((e=>W({type:"aggType",payload:e})),[]),ee=Object(i.useCallback)((e=>e&&W({type:"groupBy",payload:e})),[]),te=Object(i.useCallback)((e=>W({type:"termField",payload:e})),[]),se=Object(i.useCallback)((e=>e&&W({type:"termSize",payload:e})),[]),re=Object(i.useCallback)((e=>e&&W({type:"threshold",payload:e})),[]),ae=Object(i.useCallback)((e=>W({type:"size",payload:e})),[]),ie=Object(i.useCallback)((e=>W({type:"excludeHitsFromPreviousRun",payload:e})),[]),le=`${M.timeWindowSize}${M.timeWindowUnit}`,oe=Object(i.useCallback)((()=>{var e;const t=v.createCopy(),s=Object(b.getTime)(v.getField("index"),{from:`now-${le}`,to:"now"});return t.setField("filter",s?[s,...M.filter]:M.filter),t.setField("aggs",Object(j.buildAggregation)({aggType:I.aggType,aggField:I.aggField,termField:I.termField,termSize:I.termSize,condition:{conditionScript:Object(h.getComparatorScript)(null!==(e=I.thresholdComparator)&&void 0!==e?e:y.c.THRESHOLD_COMPARATOR,I.threshold,j.BUCKET_SELECTOR_FIELD)}})),t}),[v,le,M,I.aggType,I.aggField,I.termField,I.termSize,I.threshold,I.thresholdComparator]),ne=Object(i.useCallback)((()=>{const e=oe();return JSON.stringify(e.getSearchRequestBody(),null,2)}),[oe]),ue=Object(i.useCallback)((async()=>{const e=Object(j.isGroupAggregation)(I.termField),t=Object(j.isCountAggregation)(I.aggType),s=oe(),{rawResponse:r}=await Object(p.lastValueFrom)(s.fetch$());return{testResults:Object(j.parseAggregationResults)({isCountAgg:t,isGroupAgg:e,esResult:r}),isGrouped:e,timeWindow:le}}),[le,oe,I.aggType,I.termField]);return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectDataViewPrompt",defaultMessage:"Select a data view"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(x.a,{dependencies:{dataViews:T,dataViewEditor:F},dataView:L,metadata:e.metadata,onSelectDataView:G,onChangeMetaData:e.onChangeMetaData}),Boolean(null==L?void 0:L.id)&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineTextQueryPrompt",defaultMessage:"Define your query"}))),Object(E.jsx)(u.EuiSpacer,{size:"xs"}),Object(E.jsx)(S.ui.SearchBar,{appName:m.b,onQuerySubmit:({query:e})=>{(null==e?void 0:e.language)!==q.language&&W({type:"query",payload:{...q,language:null==e?void 0:e.language}})},onQueryChange:V,suggestionsSize:"s",displayStyle:"inPage",query:q,indexPatterns:B,savedQuery:z,filters:D,onFiltersUpdated:N,onClearSavedQuery:()=>{P(void 0),W({type:"query",payload:{...q,query:""}})},onSavedQueryUpdated:Y,onSaved:Y,saveQueryMenuVisibility:"allowed_by_app_privilege",showQueryInput:!0,showFilterBar:!0,showDatePicker:!1,showAutoRefreshOnly:!1,showSubmitButton:!1,dateRangeFrom:void 0,dateRangeTo:void 0,hiddenFilterPanelOptions:R})),Object(E.jsx)(u.EuiSpacer,{size:"m"}),Object(E.jsx)(k,{threshold:M.threshold,thresholdComparator:M.thresholdComparator,timeWindowSize:M.timeWindowSize,timeWindowUnit:M.timeWindowUnit,size:M.size,esFields:H,aggType:M.aggType,aggField:M.aggField,groupBy:M.groupBy,termSize:M.termSize,termField:M.termField,onChangeSelectedAggField:X,onChangeSelectedAggType:K,onChangeSelectedGroupBy:ee,onChangeSelectedTermField:te,onChangeSelectedTermSize:se,onChangeThreshold:re,onChangeThresholdComparator:$,onChangeWindowSize:J,onChangeWindowUnit:Z,onChangeSizeValue:ae,errors:w,hasValidationErrors:Object(A.a)(e.ruleParams),onTestFetch:ue,onCopyQuery:ne,excludeHitsFromPreviousRun:M.excludeHitsFromPreviousRun,onChangeExcludeHitsFromPreviousRun:ie,canSelectMultiTerms:y.c.CAN_SELECT_MULTI_TERMS}),Object(E.jsx)(u.EuiSpacer,null))},I=({ruleParams:e,errors:t,setRuleParams:s,setRuleProperty:r,metadata:a,onChangeMetaData:o})=>{const{thresholdComparator:n,threshold:c,timeWindowSize:p,timeWindowUnit:g,size:b,savedQueryId:j,searchConfiguration:m,aggType:h,aggField:x,groupBy:O,termField:f,termSize:S,excludeHitsFromPreviousRun:T}=e,{data:F}=Object(_.e)(),[v,w]=Object(i.useState)(),[C,k]=Object(i.useState)(),[A,R]=Object(i.useState)(),I=Object(i.useCallback)(((e,t)=>{s(e,t)}),[s]);return Object(i.useEffect)((()=>{(async()=>{let e=m;if(!m){const t=F.search.searchSource.createEmpty();t.setField("query",F.query.queryString.getDefaultQuery());const s=await F.dataViews.getDefaultDataView();s&&t.setField("index",s),e=t.getSerializedFields()}try{var t;const s=await F.search.searchSource.create(e);r("params",{searchConfiguration:e,timeField:null===(t=s.getField("index"))||void 0===t?void 0:t.timeFieldName,searchType:d.searchSource,timeWindowSize:null!=p?p:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=g?g:y.c.TIME_WINDOW_UNIT,threshold:null!=c?c:y.c.THRESHOLD,thresholdComparator:null!=n?n:y.c.THRESHOLD_COMPARATOR,size:null!=b?b:y.c.SIZE,aggType:null!=h?h:y.c.AGGREGATION_TYPE,aggField:x,groupBy:null!=O?O:y.c.GROUP_BY,termField:f,termSize:null!=S?S:y.c.TERM_SIZE,excludeHitsFromPreviousRun:null!=T?T:y.c.EXCLUDE_PREVIOUS_HITS}),w(s)}catch(e){R(e)}})()}),[F.search.searchSource,F.dataViews]),Object(i.useEffect)((()=>{j&&F.query.savedQueries.getSavedQuery(j).then(k)}),[F.query.savedQueries,j]),A?Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiCallOut,{color:"danger",iconType:"warning"},Object(E.jsx)("p",null,A.message)),Object(E.jsx)(u.EuiSpacer,{size:"s"})):v?Object(E.jsx)(Q,{ruleParams:e,searchSource:v,errors:t,initialSavedQuery:C,setParam:I,metadata:a,onChangeMetaData:o}):Object(E.jsx)(u.EuiEmptyPrompt,{title:Object(E.jsx)(u.EuiLoadingSpinner,{size:"xl"})})};var z=s(7),P=s(28),M=s(19),W=s(23);const L=({aggs:e,index:t,from:s,to:r,filter:a,size:i,searchAfterSortId:l,sortOrder:o,timeField:n,track_total_hits:u,fields:c,runtime_mappings:d,_source:p})=>{const g=n,b={allow_no_indices:!0,index:t,size:i,ignore_unavailable:!0,track_total_hits:null!=u&&u,body:{docvalue_fields:[n].map((e=>({field:e,format:"strict_date_optional_time"}))),query:{bool:{filter:[a,{bool:{filter:[{range:{[n]:{lte:r,gte:s,format:"strict_date_optional_time"}}}]}}]}},...e?{aggs:e}:{},sort:[{[g]:{order:null!=o?o:"asc",format:"strict_date_optional_time||epoch_millis"}}]},...d?{runtime_mappings:d}:{},...c?{fields:c}:{},...null!=p?{_source:p}:{}};return l?{...b,body:{...b.body,search_after:[l]}}:b};var q=s(35);const{useXJsonMode:D}=P.XJson,B=({ruleParams:e,setRuleParams:t,setRuleProperty:s,errors:r,data:a})=>{const{index:l,timeField:o,esQuery:n,size:b,thresholdComparator:m,threshold:x,timeWindowSize:f,timeWindowUnit:S,aggType:T,aggField:F,groupBy:v,termSize:w,termField:C,excludeHitsFromPreviousRun:R}=e,[Q,I]=Object(i.useState)({...e,timeWindowSize:null!=f?f:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=S?S:y.c.TIME_WINDOW_UNIT,threshold:null!=x?x:y.c.THRESHOLD,thresholdComparator:null!=m?m:y.c.THRESHOLD_COMPARATOR,size:null!=b?b:y.c.SIZE,esQuery:null!=n?n:y.c.QUERY,aggType:null!=T?T:y.c.AGGREGATION_TYPE,groupBy:null!=v?v:y.c.GROUP_BY,termSize:null!=w?w:y.c.TERM_SIZE,searchType:d.esQuery,excludeHitsFromPreviousRun:null!=R?R:y.c.EXCLUDE_PREVIOUS_HITS}),P=Object(i.useCallback)(((e,s)=>{I((t=>({...t,[e]:s}))),t(e,s)}),[t]),B=Object(_.e)(),{http:H,docLinks:U}=B,[G,N]=Object(i.useState)([]),[V,Y]=Object(i.useState)([]),[Z,J]=Object(i.useState)([]),{convertToJson:$,setXJson:X,xJson:K}=D(y.c.QUERY);Object(i.useEffect)((()=>{(async()=>{s("params",Q),X(null!=n?n:y.c.QUERY),l&&l.length>0&&await ee(l)})()}),[]);const ee=async e=>{const t=await Object(O.getFields)(H,e);N(t),J(Object(z.sortBy)(t.concat(V),"name"))},te=Object(i.useCallback)((async()=>{const e=Object(j.isGroupAggregation)(C),t=Object(j.isCountAggregation)(T),s=`${f}${S}`;if(Object(A.a)(Q))return{testResults:{results:[],truncated:!1},isGrouped:e,timeWindow:s};const r=Object(W.parseDuration)(s),i=JSON.parse(n),u=Date.now(),{rawResponse:c}=await Object(p.lastValueFrom)(a.search.search({params:L({index:l,from:new Date(u-r).toISOString(),to:new Date(u).toISOString(),filter:i.query,size:0,searchAfterSortId:void 0,timeField:o||"",track_total_hits:!0,aggs:Object(j.buildAggregation)({aggType:T,aggField:F,termField:C,termSize:w,condition:{conditionScript:Object(h.getComparatorScript)(null!=m?m:y.c.THRESHOLD_COMPARATOR,x,j.BUCKET_SELECTOR_FIELD)}})})}));return{testResults:Object(j.parseAggregationResults)({isCountAgg:t,isGroupAgg:e,esResult:c}),isGrouped:e,timeWindow:s}}),[f,S,Q,n,a.search,l,o,T,F,C,w,x,m]);return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectIndexPrompt",defaultMessage:"Select indices"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(q.a,{index:l,"data-test-subj":"indexSelectPopover",esFields:G,timeField:o,errors:r,onIndexChange:async t=>{P("index",t),0===t.length?s("params",{timeField:e.timeField,index:t,esQuery:y.c.QUERY,size:y.c.SIZE,thresholdComparator:y.c.THRESHOLD_COMPARATOR,timeWindowSize:y.c.TIME_WINDOW_SIZE,timeWindowUnit:y.c.TIME_WINDOW_UNIT,threshold:y.c.THRESHOLD,aggType:y.c.AGGREGATION_TYPE,groupBy:y.c.GROUP_BY,termSize:y.c.TERM_SIZE,searchType:d.esQuery,excludeHitsFromPreviousRun:y.c.EXCLUDE_PREVIOUS_HITS}):await ee(t)},onTimeFieldChange:e=>P("timeField",e)}),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineQueryPrompt",defaultMessage:"Define your query using Query DSL"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFormRow,{id:"queryEditor","data-test-subj":"queryJsonEditor",fullWidth:!0,isInvalid:r.esQuery.length>0,error:r.esQuery,helpText:Object(E.jsx)(u.EuiLink,{href:U.links.query.queryDsl,target:"_blank"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.queryPrompt.help",defaultMessage:"Elasticsearch Query DSL documentation"}))},Object(E.jsx)(M.CodeEditor,{languageId:"xjson",width:"100%",height:"200px",value:K,onChange:e=>{X(e),P("esQuery",$(e)),(e=>{let t;try{t=Object(z.get)(JSON.parse(e),"runtime_mappings")}catch(e){}if(t){const e=Object(_.b)(t);Y(e),J(Object(z.sortBy)(G.concat(e),"name"))}})(e)},options:{ariaLabel:c.i18n.translate("xpack.stackAlerts.esQuery.ui.queryEditor",{defaultMessage:"Elasticsearch query editor"}),wordWrap:"off",tabSize:2,lineNumbers:"off",lineNumbersMinChars:0,folding:!1,lineDecorationsWidth:0,overviewRulerBorder:!1}})),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(k,{threshold:null!=x?x:y.c.THRESHOLD,thresholdComparator:null!=m?m:y.c.THRESHOLD_COMPARATOR,timeWindowSize:f,timeWindowUnit:S,size:b,esFields:Z,aggType:T,aggField:F,groupBy:v,termSize:w,termField:C,onChangeSelectedAggField:Object(i.useCallback)((e=>P("aggField",e)),[P]),onChangeSelectedAggType:Object(i.useCallback)((e=>P("aggType",e)),[P]),onChangeSelectedGroupBy:Object(i.useCallback)((e=>P("groupBy",e)),[P]),onChangeSelectedTermField:Object(i.useCallback)((e=>P("termField",e)),[P]),onChangeSelectedTermSize:Object(i.useCallback)((e=>P("termSize",e)),[P]),onChangeThreshold:Object(i.useCallback)((e=>P("threshold",e)),[P]),onChangeThresholdComparator:Object(i.useCallback)((e=>P("thresholdComparator",e)),[P]),onChangeWindowSize:Object(i.useCallback)((e=>P("timeWindowSize",e)),[P]),onChangeWindowUnit:Object(i.useCallback)((e=>P("timeWindowUnit",e)),[P]),onChangeSizeValue:Object(i.useCallback)((e=>P("size",e)),[P]),errors:r,hasValidationErrors:Object(A.a)(Q),onTestFetch:te,excludeHitsFromPreviousRun:R,onChangeExcludeHitsFromPreviousRun:Object(i.useCallback)((e=>P("excludeHitsFromPreviousRun",e)),[P]),canSelectMultiTerms:y.c.CAN_SELECT_MULTI_TERMS}),Object(E.jsx)(u.EuiSpacer,null))},H=l.a.memo((()=>Object(E.jsx)(u.EuiBetaBadge,{size:"s",label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.experimentalLabel",{defaultMessage:"Technical preview"}),tooltipContent:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.experimentalDescription",{defaultMessage:"This functionality is in technical preview and may be changed or removed completely in a future release. Elastic will work to fix any issues, but features in technical preview are not subject to the support SLA of official GA features."}),tooltipPosition:"bottom"})));H.displayName="ExperimentalBadge";const U=({searchType:e,onFormTypeSelect:t})=>{const{uiSettings:s}=Object(_.e)(),r=null==s?void 0:s.get("discover:enableESQL"),a=Object(i.useMemo)((()=>{const e=[{formType:d.searchSource,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeLabel",{defaultMessage:"KQL or Lucene"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.kqlOrLuceneFormTypeDescription",{defaultMessage:"Use KQL or Lucene to define a text-based query."})},{formType:d.esQuery,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeLabel",{defaultMessage:"Query DSL"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.queryDslFormTypeDescription",{defaultMessage:"Use the Elasticsearch Query DSL to define a query."})}];return r&&e.push({formType:d.esqlQuery,label:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.esqlFormTypeLabel",{defaultMessage:"ES|QL"}),description:c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.esqlFormTypeDescription",{defaultMessage:"Use ES|QL to define a text-based query."})}),e}),[r]);if(e){const s=a.find((t=>t.formType===e));return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s",responsive:!1},Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiTitle,{size:"xs","data-test-subj":"selectedRuleFormTypeTitle"},Object(E.jsx)("h5",null,null==s?void 0:s.label))),(null==s?void 0:s.formType)===d.esqlQuery&&Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(H,null)))),Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiButtonIcon,{iconType:"cross",color:"danger","data-test-subj":"queryFormTypeChooserCancel","aria-label":c.i18n.translate("xpack.stackAlerts.esQuery.ui.selectQueryFormType.cancelSelectionAriaLabel",{defaultMessage:"Cancel selection"}),onClick:()=>t(null)}))),Object(E.jsx)(u.EuiText,{color:"subdued",size:"s","data-test-subj":"selectedRuleFormTypeDescription"},null==s?void 0:s.description),Object(E.jsx)(u.EuiSpacer,null))}return Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",{"data-test-subj":"queryFormTypeChooserTitle"},Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectQueryFormTypeLabel",defaultMessage:"Select a query type"}))),Object(E.jsx)(u.EuiListGroup,{flush:!0,gutterSize:"m",size:"m",maxWidth:!1},a.map((e=>Object(E.jsx)(u.EuiListGroupItem,{wrapText:!0,key:`form-type-${e.formType}`,"data-test-subj":`queryFormType_${e.formType}`,color:"primary",label:Object(E.jsx)("span",null,Object(E.jsx)(u.EuiFlexGroup,{alignItems:"center",gutterSize:"s"},Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)("strong",null,e.label)),e.formType===d.esqlQuery&&Object(E.jsx)(u.EuiFlexItem,null,Object(E.jsx)(H,null))),Object(E.jsx)(u.EuiText,{color:"subdued",size:"s"},Object(E.jsx)("p",null,e.description))),onClick:()=>t(e.formType)})))),Object(E.jsx)(u.EuiSpacer,null))};var G=s(29),N=s(30),V=s(31),Y=s(9);const Z=({ruleParams:e,setRuleParams:t,setRuleProperty:s,errors:r})=>{const{expressions:a,http:l}=Object(_.e)(),{esqlQuery:o,timeWindowSize:n,timeWindowUnit:c,timeField:b}=e,[m,x]=Object(i.useState)({...e,timeWindowSize:null!=n?n:y.c.TIME_WINDOW_SIZE,timeWindowUnit:null!=c?c:y.c.TIME_WINDOW_UNIT,threshold:[0],thresholdComparator:y.c.THRESHOLD_COMPARATOR,size:y.c.SIZE,esqlQuery:null!=o?o:{esql:""},aggType:y.c.AGGREGATION_TYPE,groupBy:y.c.GROUP_BY,termSize:y.c.TERM_SIZE,searchType:d.esqlQuery}),[f,S]=Object(i.useState)({esql:""}),[T,v]=Object(i.useState)([j.firstFieldOption]),[w,C]=Object(i.useState)(!1),k=Object(i.useCallback)(((e,s)=>{x((t=>({...t,[e]:s}))),t(e,s)}),[t]);Object(i.useEffect)((()=>{(async()=>{s("params",m),S(null!=o?o:{esql:""}),o&&"esql"in o&&o.esql&&Q(o),b&&v([j.firstFieldOption,{text:b,value:b}])})()}),[]);const R=Object(i.useCallback)((async()=>{const e=`${n}${c}`,t={testResults:{results:[],truncated:!1},isGrouped:!0,timeWindow:e};if(Object(A.a)(m))return t;const s=Object(W.parseDuration)(e),r=Date.now(),i=await function(e,t,s){return Object(V.textBasedQueryStateToAstWithValidation)({query:e,time:s}).then((e=>{if(e){const s=t.run(e,null);let r,a;return s.pipe(Object(N.pluck)("result")).subscribe((e=>{const t=e;"error"===t.type?a=t.error.message:r=t})),Object(p.lastValueFrom)(s).then((()=>{if(a)throw new Error(a);return r}))}})).catch((e=>{throw new Error(e.message)}))}(o,a,{from:new Date(r-s).toISOString(),to:new Date(r).toISOString()});if(i){const t=Object(h.transformDatatableToEsqlTable)(i),s=Object(h.toEsQueryHits)(t);return{testResults:Object(j.parseAggregationResults)({isCountAgg:!0,isGroupAgg:!1,esResult:{took:0,timed_out:!1,_shards:{failed:0,successful:0,total:0},hits:s}}),isGrouped:!1,timeWindow:e,rawResults:{cols:t.columns.map((e=>({id:e.name}))),rows:t.values.slice(0,5).map((e=>Object(h.rowToDocument)(t.columns,e)))}}}return t}),[n,c,m,o,a]),Q=async e=>{let t=!1;const s=Object(Y.getIndexPatternFromESQLQuery)(Object(z.get)(e,"esql")),r=await Object(O.getFields)(l,[s]),a=Object(j.getTimeFieldOptions)(r);v([j.firstFieldOption,...a]);const i=a.find((e=>"@timestamp"===e.value));i&&(k("timeField",i.value),t=!0),C(t)};return Object(E.jsx)(i.Fragment,null,Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.defineEsqlQueryPrompt",defaultMessage:"Define your query using ES|QL"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFormRow,{id:"queryEditor","data-test-subj":"queryEsqlEditor",fullWidth:!0},Object(E.jsx)(G.TextBasedLangEditor,{query:f,onTextLangQueryChange:e=>{S(e),k("esqlQuery",e),Q(e)},expandCodeEditor:()=>!0,isCodeEditorExpanded:!0,onTextLangQuerySubmit:()=>{},detectTimestamp:w,hideMinimizeButton:!0,hideRunQueryText:!0})),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.selectEsqlQueryTimeFieldPrompt",defaultMessage:"Select a time field"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFormRow,{id:"timeField",fullWidth:!0,isInvalid:r.timeField.length>0&&void 0!==b,error:r.timeField},Object(E.jsx)(u.EuiSelect,{options:T,isInvalid:r.timeField.length>0&&void 0!==b,fullWidth:!0,name:"timeField","data-test-subj":"timeFieldSelect",value:b||"",onChange:e=>{k("timeField",e.target.value)}})),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(u.EuiTitle,{size:"xs"},Object(E.jsx)("h5",null,Object(E.jsx)(g.FormattedMessage,{id:"xpack.stackAlerts.esQuery.ui.setEsqlQueryTimeWindowPrompt",defaultMessage:"Set the time window"}))),Object(E.jsx)(u.EuiSpacer,{size:"s"}),Object(E.jsx)(u.EuiFlexGroup,null,Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiFormRow,{id:"timeWindowSize",isInvalid:r.timeWindowSize.length>0,error:r.timeWindowSize},Object(E.jsx)(u.EuiFieldNumber,{name:"timeWindowSize","data-test-subj":"timeWindowSizeNumber",isInvalid:r.timeWindowSize.length>0,min:0,value:n||"",onChange:e=>{const{value:t}=e.target,s=""!==t?parseInt(t,10):void 0;k("timeWindowSize",s)}}))),Object(E.jsx)(u.EuiFlexItem,{grow:!1},Object(E.jsx)(u.EuiFormRow,{id:"timeWindowUnit"},Object(E.jsx)(u.EuiSelect,{name:"timeWindowUnit","data-test-subj":"timeWindowUnitSelect",value:c,onChange:e=>{k("timeWindowUnit",e.target.value)},options:Object(j.getTimeOptions)(null!=n?n:1)})))),Object(E.jsx)(u.EuiSpacer,null),Object(E.jsx)(F,{fetch:R,hasValidationErrors:Object(A.a)(m),showTable:!0}))};function J(e,t){const s=n()(e.errors,t.errors),r=n()(e.ruleParams,t.ruleParams);return s&&r}const $=Object(i.memo)(I,J);t.default=e=>{var t,s;const{ruleParams:r,errors:o,setRuleProperty:n,setRuleParams:d}=e,p=Object(_.d)(r),g=Object(_.c)(r),b=null===(t=null===(s=e.metadata)||void 0===s?void 0:s.isManagementPage)||void 0===t||t,j=Object(i.useCallback)((e=>{e?d("searchType",e):n("params",{})}),[d,n]),m=c.i18n.translate("xpack.stackAlerts.esQuery.ui.alertParams.fixErrorInExpressionBelowValidationMessage",{defaultMessage:"Expression contains errors."}),h=y.a.find((e=>{var t;return(null===(t=o[e])||void 0===t?void 0:t.length)>=1&&void 0!==r[e]})),x=!!h&&Object(E.jsx)(l.a.Fragment,null,Object(E.jsx)(u.EuiCallOut,{color:"danger",size:"s","data-test-subj":"esQueryAlertExpressionError",title:["index","searchType","timeField"].includes(h)?o[h]:m}),Object(E.jsx)(u.EuiSpacer,null));return Object(E.jsx)(l.a.Fragment,null,x,b&&Object(E.jsx)(U,{searchType:r.searchType,onFormTypeSelect:j}),r.searchType&&p&&Object(E.jsx)($,a()({},e,{ruleParams:r})),r.searchType&&!p&&!g&&Object(E.jsx)(B,a()({},e,{ruleParams:r})),r.searchType&&g&&Object(E.jsx)(Z,a()({},e,{ruleParams:r})),Object(E.jsx)(u.EuiHorizontalRule,null))}}}]);