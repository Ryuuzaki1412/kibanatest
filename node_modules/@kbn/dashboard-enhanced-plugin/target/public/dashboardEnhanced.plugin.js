/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */!function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=19)}([function(e,t,n){e.exports=n(16)(2)},function(e,t){e.exports=__kbnSharedDeps__.EmotionReact},function(e,t){e.exports=__kbnSharedDeps__.RxjsOperators},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/embeddable/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t){e.exports=__kbnSharedDeps__.KbnI18n},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/embeddableEnhanced/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t){e.exports=__kbnSharedDeps__.React},function(e,t){e.exports=__kbnSharedDeps__.ElasticEui},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/kibanaUtils/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/data/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/presentationUtil/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t){e.exports=__kbnSharedDeps__.Rxjs},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/kibanaReact/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t){e.exports=__kbnSharedDeps__.KbnEsQuery},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/dashboard/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t){e.exports=__kbnSharedDeps__.Lodash},function(e,t){e.exports=__kbnSharedDeps_npm__},function(e,t,n){n.r(t);var o=__kbnBundles__.get("plugin/imageEmbeddable/public");Object.defineProperties(t,Object.getOwnPropertyDescriptors(o))},function(e,t,n){e.exports=n(16)(3)},function(e,t,n){n(20),__kbnBundles__.define("plugin/dashboardEnhanced/public",n,21)},function(e,t,n){n.p=window.__kbnPublicPath__.dashboardEnhanced},function(e,t,n){"use strict";n.r(t),n.d(t,"DashboardEnhancedAbstractDashboardDrilldown",(function(){return abstract_dashboard_drilldown_AbstractDashboardDrilldown})),n.d(t,"plugin",(function(){return F}));var o=n(0),a=n.n(o),r=n(3),s=n(8),i=n(6),d=n.n(i),c=n(4),l=n(2),b=n(11),u=n(12),h=n(5),p=n(9);function g(e){return e.includes(p.APPLY_FILTER_TRIGGER)||!e.includes(r.VALUE_CLICK_TRIGGER)&&!e.includes(r.SELECT_RANGE_TRIGGER)?e:[...e,p.APPLY_FILTER_TRIGGER]}const _=e=>{const t=[],n=e.id,o=e.getRoot();if(!o)return t;if(!(o instanceof r.Container))return t;const a=o.getChildIds();for(const e of a){const a=o.getChild(e);if(a.id===n)continue;if(!Object(h.isEnhancedEmbeddable)(a))continue;const r=a.enhancements.dynamicActions.state.get().events;for(const e of r){const n={id:e.eventId,name:e.action.name,icon:"dashboardApp",description:a.getTitle()||a.id,config:e.action.config,factoryId:e.action.factoryId,triggers:e.triggers};t.push(n)}}return t};var f=n(1);const m="OPEN_FLYOUT_ADD_DRILLDOWN";class flyout_create_drilldown_FlyoutCreateDrilldownAction{constructor(e){a()(this,"type",m),a()(this,"id",m),a()(this,"order",12),a()(this,"grouping",h.embeddableEnhancedDrilldownGrouping),this.params=e}getDisplayName(){return c.i18n.translate("xpack.dashboard.FlyoutCreateDrilldownAction.displayName",{defaultMessage:"Create drilldown"})}getIconType(){return"plusInCircle"}isEmbeddableCompatible(e){if(!Object(h.isEnhancedEmbeddable)(e.embeddable))return!1;if("dashboard"!==e.embeddable.getRoot().type)return!1;const t=[r.CONTEXT_MENU_TRIGGER,...e.embeddable.supportedTriggers()||[]],n=this.params.start().plugins.uiActionsEnhanced.getActionFactories().map((e=>e.isCompatibleLicense()?e.supportedTriggers():[])).reduce(((e,t)=>e.concat(t)),[]);return g(t).some((e=>n.includes(e)))}async isCompatible(e){return"edit"===e.embeddable.getInput().viewMode&&this.isEmbeddableCompatible(e)}async execute(e){const{core:t,plugins:n}=this.params.start(),{embeddable:o}=e;if(!Object(h.isEnhancedEmbeddable)(o))throw new Error("Need embeddable to be EnhancedEmbeddable to execute FlyoutCreateDrilldownAction.");const a=_(o),s=new b.Subject,i=()=>{s.next(!0),p.close()},d=()=>{i()},c=[...g(o.supportedTriggers()),r.CONTEXT_MENU_TRIGGER],p=t.overlays.openFlyout(Object(u.toMountPoint)(Object(f.jsx)(n.uiActionsEnhanced.DrilldownManager,{closeAfterCreate:!0,initialRoute:"/new",dynamicActionManager:o.enhancements.dynamicActions,triggers:c,placeContext:{embeddable:o},templates:a,onClose:i}),{theme$:t.theme.theme$}),{ownFocus:!0,"data-test-subj":"createDrilldownFlyout"});t.application.currentAppId$.pipe(Object(l.takeUntil)(s),Object(l.skip)(1),Object(l.take)(1)).subscribe(d),o.getInput$().pipe(Object(l.takeUntil)(s),Object(l.map)((e=>e.viewMode)),Object(l.distinctUntilChanged)(),Object(l.filter)((e=>e!==r.ViewMode.EDIT)),Object(l.take)(1)).subscribe({next:d,complete:d})}}const D=c.i18n.translate("xpack.dashboard.panel.openFlyoutEditDrilldown.displayName",{defaultMessage:"Manage drilldowns"});var O=n(7);const w=({context:e})=>{const{events:t}=Object(s.useContainerState)(e.embeddable.enhancements.dynamicActions.state),n=t.length;return Object(f.jsx)(O.EuiFlexGroup,{alignItems:"center"},Object(f.jsx)(O.EuiFlexItem,{grow:!0},D),n>0&&Object(f.jsx)(O.EuiFlexItem,{grow:!1},Object(f.jsx)(O.EuiNotificationBadge,null,n)))},j="OPEN_FLYOUT_EDIT_DRILLDOWN";class flyout_edit_drilldown_FlyoutEditDrilldownAction{constructor(e){a()(this,"type",j),a()(this,"id",j),a()(this,"order",10),a()(this,"grouping",h.embeddableEnhancedDrilldownGrouping),a()(this,"MenuItem",w),this.params=e}getDisplayName(){return D}getIconType(){return"list"}async isCompatible({embeddable:e}){return e.getInput().viewMode===r.ViewMode.EDIT&&!!Object(h.isEnhancedEmbeddable)(e)&&e.enhancements.dynamicActions.state.get().events.length>0}async execute(e){const{core:t,plugins:n}=this.params.start(),{embeddable:o}=e;if(!Object(h.isEnhancedEmbeddable)(o))throw new Error("Need embeddable to be EnhancedEmbeddable to execute FlyoutEditDrilldownAction.");const a=_(o),s=new b.Subject,i=()=>{s.next(!0),c.close()},d=()=>{i()},c=t.overlays.openFlyout(Object(u.toMountPoint)(Object(f.jsx)(n.uiActionsEnhanced.DrilldownManager,{initialRoute:"/manage",dynamicActionManager:o.enhancements.dynamicActions,triggers:[...g(o.supportedTriggers()),r.CONTEXT_MENU_TRIGGER],placeContext:{embeddable:o},templates:a,onClose:i}),{theme$:t.theme.theme$}),{ownFocus:!0,"data-test-subj":"editDrilldownFlyout"});t.application.currentAppId$.pipe(Object(l.takeUntil)(s),Object(l.skip)(1),Object(l.take)(1)).subscribe(d),o.getInput$().pipe(Object(l.takeUntil)(s),Object(l.map)((e=>e.viewMode)),Object(l.distinctUntilChanged)(),Object(l.filter)((e=>e!==r.ViewMode.EDIT)),Object(l.take)(1)).subscribe({next:d,complete:d})}}var E=n(13),v=n(14),I=n(17),y=n(18),C=n.n(y),x=n(10),T=n(15);const S=c.i18n.translate("xpack.dashboard.components.DashboardDrilldownConfig.chooseDestinationDashboard",{defaultMessage:"Choose destination dashboard"}),R=Object(x.withSuspense)(x.DashboardDrilldownOptionsComponent,null),A=({dashboards:e,onDashboardSelect:t,onSearchChange:n,isLoading:o,error:a,config:r,onConfigChange:s})=>{var i;const c=(null===(i=e.find((e=>e.value===r.dashboardId)))||void 0===i?void 0:i.label)||"";return Object(f.jsx)(d.a.Fragment,null,Object(f.jsx)(O.EuiFormRow,{label:S,fullWidth:!0,isInvalid:!!a,error:a},Object(f.jsx)(O.EuiComboBox,{async:!0,selectedOptions:r.dashboardId?[{label:c,value:r.dashboardId}]:[],options:e,onChange:([{value:e=""}={value:""}])=>t(e),onSearchChange:n,isLoading:o,singleSelection:{asPlainText:!0},fullWidth:!0,"data-test-subj":"dashboardDrilldownSelectDashboard",isInvalid:!!a})),Object(f.jsx)(R,{options:r,onOptionChange:s}))},P=(e,t)=>t&&-1===Object(T.findIndex)(e,{value:t.value})?[t,...e]:e,L=e=>({value:e.id,label:e.attributes.title});class collect_config_container_CollectConfigContainer extends d.a.Component{constructor(e){super(e),a()(this,"isMounted",!0),a()(this,"state",{dashboards:[],isLoading:!1,searchString:void 0,selectedDashboard:void 0,error:void 0}),a()(this,"debouncedLoadDashboards",void 0),this.debouncedLoadDashboards=Object(T.debounce)(this.loadDashboards.bind(this),500)}componentDidMount(){this.loadSelectedDashboard(),this.loadDashboards()}componentWillUnmount(){this.isMounted=!1}render(){const{config:e,onConfig:t}=this.props,{dashboards:n,selectedDashboard:o,isLoading:a,error:r}=this.state;return Object(f.jsx)(A,{dashboards:P(n,o),isLoading:a,error:r,onDashboardSelect:n=>{t({...e,dashboardId:n}),this.state.error&&this.setState({error:void 0})},onSearchChange:this.debouncedLoadDashboards,config:e,onConfigChange:n=>{t({...e,...n})}})}async loadSelectedDashboard(){var e;const{config:t,params:{start:n}}=this.props;if(!t.dashboardId)return;const o=await n().core.savedObjects.client.get("dashboard",t.dashboardId);var a;return this.isMounted?404===(null===(e=o.error)||void 0===e?void 0:e.statusCode)?(this.setState({error:(a=t.dashboardId,c.i18n.translate("xpack.dashboard.drilldown.errorDestinationDashboardIsMissing",{defaultMessage:"Destination dashboard ('{dashboardId}') no longer exists. Choose another dashboard.",values:{dashboardId:a}}))}),void this.props.onConfig({...t,dashboardId:void 0})):o.error?(this.setState({error:o.error.message}),void this.props.onConfig({...t,dashboardId:void 0})):void this.setState({selectedDashboard:L(o)}):void 0}async loadDashboards(e){this.setState({searchString:e,isLoading:!0});const t=this.props.params.start().core.savedObjects.client,{savedObjects:n}=await t.find({type:"dashboard",search:e?`${e}*`:void 0,searchFields:["title^3","description"],defaultSearchOperator:"AND",perPage:100});if(!this.isMounted)return;if(e!==this.state.searchString)return;const o=n.map(L);this.setState({dashboards:o,isLoading:!1})}}const k=c.i18n.translate("xpack.dashboard.drilldown.goToDashboard",{defaultMessage:"Go to Dashboard"});class abstract_dashboard_drilldown_AbstractDashboardDrilldown{constructor(e){a()(this,"order",100),a()(this,"getDisplayName",(()=>k)),a()(this,"euiIcon","dashboardApp"),a()(this,"ReactCollectConfig",void 0),a()(this,"CollectConfig",void 0),a()(this,"createConfig",(()=>({dashboardId:"",...x.DEFAULT_DASHBOARD_DRILLDOWN_OPTIONS}))),a()(this,"isConfigValid",(e=>!!e.dashboardId)),a()(this,"getHref",(async(e,t)=>{const{app:n,path:o}=await this.getLocation(e,t,!0);return await this.params.start().core.application.getUrlForApp(n,{path:o,absolute:!0})})),a()(this,"execute",(async(e,t)=>{if(e.openInNewTab)window.open(await this.getHref(e,t),"_blank");else{const{app:n,path:o,state:a}=await this.getLocation(e,t,!1);await this.params.start().core.application.navigateToApp(n,{path:o,state:a})}})),this.params=e,this.ReactCollectConfig=e=>Object(f.jsx)(collect_config_container_CollectConfigContainer,C()({},e,{params:this.params})),this.CollectConfig=this.ReactCollectConfig}get locator(){const e=this.params.start().plugins.dashboard.locator;if(!e)throw new Error("Dashboard locator is required for dashboard drilldown.");return e}}const M=(e,t)=>`drilldown:${t}:${e.eventId}:dashboardId`;class embeddable_to_dashboard_drilldown_EmbeddableToDashboardDrilldown extends abstract_dashboard_drilldown_AbstractDashboardDrilldown{constructor(...e){super(...e),a()(this,"id","DASHBOARD_TO_DASHBOARD_DRILLDOWN"),a()(this,"supportedTriggers",(()=>[p.APPLY_FILTER_TRIGGER,I.IMAGE_CLICK_TRIGGER])),a()(this,"inject",(({drilldownId:e})=>(t,n)=>{const o=t.action,a=M(t,e),r=n.find((e=>e.name===a));return r?r.id&&r.id===o.config.dashboardId?t:((e,t)=>({...e,action:{...e.action,config:{...e.action.config,dashboardId:t}}}))(t,r.id):t})({drilldownId:this.id})),a()(this,"extract",(({drilldownId:e})=>t=>{const n=t.action,o=n.config.dashboardId?[{name:M(t,e),type:"dashboard",id:n.config.dashboardId}]:[],{dashboardId:a,...r}=n.config;return{state:{...t,action:{...t.action,config:r}},references:o}})({drilldownId:this.id}))}async getLocation(e,t,n){let o={dashboardId:e.dashboardId};t.embeddable&&(o={...o,...Object(v.getDashboardLocatorParamsFromEmbeddable)(t.embeddable,e)});const{restOfFilters:a,timeRange:r}=Object(E.extractTimeRange)(t.filters,t.timeFieldName);var s;a&&(o.filters=[...null!==(s=o.filters)&&void 0!==s?s:[],...a]),r&&(o.timeRange=r);const i=await this.locator.getLocation(o);return n&&this.useUrlForState(i),i}useUrlForState(e){var t;const n=e.state;e.path=Object(s.setStateToKbnUrl)("_a",Object(v.cleanEmptyKeys)({query:n.query,filters:null===(t=n.filters)||void 0===t?void 0:t.filter((e=>!Object(E.isFilterPinned)(e)))}),{useHash:!1,storeInHashQuery:!0},e.path)}}class dashboard_drilldowns_services_DashboardDrilldownsService{bootstrap(e,t,{enableDrilldowns:n}){n&&this.setupDrilldowns(e,t)}setupDrilldowns(e,{uiActionsEnhanced:t}){const n=Object(s.createStartServicesGetter)(e.getStartServices),o=new flyout_create_drilldown_FlyoutCreateDrilldownAction({start:n});t.addTriggerAction(r.CONTEXT_MENU_TRIGGER,o);const a=new flyout_edit_drilldown_FlyoutEditDrilldownAction({start:n});t.addTriggerAction(r.CONTEXT_MENU_TRIGGER,a);const i=new embeddable_to_dashboard_drilldown_EmbeddableToDashboardDrilldown({start:n});t.registerDrilldown(i)}}class plugin_DashboardEnhancedPlugin{constructor(e){a()(this,"drilldowns",new dashboard_drilldowns_services_DashboardDrilldownsService),this.context=e}setup(e,t){return this.drilldowns.bootstrap(e,t,{enableDrilldowns:!0}),{}}start(e,t){return{}}stop(){}}function F(e){return new plugin_DashboardEnhancedPlugin(e)}}]);