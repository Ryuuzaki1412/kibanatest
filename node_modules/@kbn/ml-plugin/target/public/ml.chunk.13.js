/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[13,34],{116:function(e,t,n){"use strict";n.d(t,"j",(function(){return u})),n.d(t,"g",(function(){return f})),n.d(t,"h",(function(){return g})),n.d(t,"f",(function(){return b})),n.d(t,"k",(function(){return p})),n.d(t,"n",(function(){return m})),n.d(t,"e",(function(){return y})),n.d(t,"d",(function(){return O})),n.d(t,"l",(function(){return v})),n.d(t,"m",(function(){return T})),n.d(t,"a",(function(){return E})),n.d(t,"b",(function(){return N})),n.d(t,"i",(function(){return h})),n.d(t,"c",(function(){return C}));var i=n(3),a=n(118),r=n(101),o=n(122),l=n(1),d=n(117),s=n(106);const c=e=>t=>{let n=o.b.getFieldById(t);return null===n&&(t===r.e?n=r.H:e.length&&(n=e.find((e=>e.id===t))||null)),n};function u(e,t,n,i=!1){const a=i?function(e,t){return _(e.analysis_config.detectors)}(e):function(e,t){let n=e.analysis_config.detectors;const i=p(e,t);if(void 0!==t.aggregations&&e.analysis_config.detectors[0].function===r.n.NON_ZERO_COUNT&&!1===i){var a,o,l,d,s;const e=null==t||null===(a=t.aggregations)||void 0===a||null===(o=a.buckets)||void 0===o||null===(l=o.aggregations)||void 0===l||null===(d=l.dc_region)||void 0===d||null===(s=d.cardinality)||void 0===s?void 0:s.field;void 0!==e&&(n=[{function:r.n.DISTINCT_COUNT,field_name:e}])}else n=_(n),n=n.map((e=>{switch(e.function){case r.n.NON_ZERO_COUNT:return{...e,field_name:r.c,function:r.n.COUNT};case r.n.HIGH_NON_ZERO_COUNT:return{...e,field_name:r.c,function:r.n.HIGH_COUNT};case r.n.LOW_NON_ZERO_COUNT:return{...e,field_name:r.c,function:r.n.LOW_COUNT};case r.n.NON_NULL_SUM:return{...e,function:r.n.SUM};case r.n.HIGH_NON_NULL_SUM:return{...e,function:r.n.HIGH_SUM};case r.n.LOW_NON_NULL_SUM:return{...e,function:r.n.LOW_SUM};default:return e}}));return n}(e,t),l=c(n);return a.map((e=>{var t,n,i;let a=null,r=null,d=null,s=null;return void 0!==e.field_name&&(a=l(e.field_name)),void 0!==e.by_field_name&&(r=l(e.by_field_name)),void 0!==e.over_field_name&&(d=l(e.over_field_name)),void 0!==e.partition_field_name&&(s=l(e.partition_field_name)),{agg:o.b.getAggById(e.function),field:a,byField:r,overField:d,partitionField:s,excludeFrequent:null!==(t=e.exclude_frequent)&&void 0!==t?t:null,description:null!==(n=e.detector_description)&&void 0!==n?n:null,useNull:null!==(i=e.use_null)&&void 0!==i?i:null}}))}function f(e,t){return[...e.filter((e=>e.id!==r.c)).map((e=>({label:e.name,field:e}))),...t.filter((t=>!1===e.some((e=>e.id===t.id)))).map((e=>({label:e.id,field:e})))].sort(((e,t)=>e.label.localeCompare(t.label)))}function g(e){return null===e?[]:[{label:r.e}]}function b(e){return e?[{label:r.a}]:[{label:r.u}]}function _(e){return e.map((e=>{switch(e.function){case r.n.COUNT:case r.n.HIGH_COUNT:case r.n.LOW_COUNT:case r.n.NON_ZERO_COUNT:case r.n.HIGH_NON_ZERO_COUNT:case r.n.LOW_NON_ZERO_COUNT:case r.n.RARE:case r.n.FREQ_RARE:case r.n.TIME_OF_DAY:case r.n.TIME_OF_WEEK:return{...e,field_name:r.c};default:return e}}))}function p(e,t){var n,i,a,o,l;const d=e.analysis_config.detectors;if(void 0===(null==t||null===(n=t.aggregations)||void 0===n||null===(i=n.buckets)||void 0===i||null===(a=i.aggregations)||void 0===a||null===(o=a.dc_region)||void 0===o||null===(l=o.cardinality)||void 0===l?void 0:l.field))for(const e of d)if(r.t.includes(e.function))return!0;return!1}function m(e,t=!1,n=!1,i=!1){var a;d.a.tempJobCloningObjects.job=e.jobConfig,d.a.tempJobCloningObjects.datafeed=e.datafeedConfig,d.a.tempJobCloningObjects.createdBy=null!==(a=e.createdBy)&&void 0!==a?a:void 0,d.a.tempJobCloningObjects.skipTimeRangeStep=t,!0===n&&!1===i?(d.a.tempJobCloningObjects.start=e.start,d.a.tempJobCloningObjects.end=e.end):!0===i&&(d.a.tempJobCloningObjects.autoSetTimeRange=!0),d.a.tempJobCloningObjects.calendars=e.calendars}function y(e,t){e.createdBy=s.a.MULTI_METRIC,e.modelPlot=!1,m(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_MULTI_METRIC,!0)}function O(e,t){e.createdBy=null,m(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB_CONVERT_TO_ADVANCED,!0)}function v(e,t){e.createdBy=null,m(e,!0,!1),t(l.b.ANOMALY_DETECTION_CREATE_JOB)}function T(e,t){e.jobId="",m(e,!0,!0),t(l.b.ANOMALY_DETECTION_CREATE_JOB)}function E(e,t){null!==e&&m(e,!1,!1),t("/jobs")}function N(e){return!1===e.some((e=>null===e.agg.dslName))}function h(e){switch(e.type){case s.f.SINGLE_METRIC:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.singleMetric",{defaultMessage:"Single metric"});case s.f.MULTI_METRIC:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.multiMetric",{defaultMessage:"Multi-metric"});case s.f.POPULATION:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.population",{defaultMessage:"Population"});case s.f.ADVANCED:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.advanced",{defaultMessage:"Advanced"});case s.f.CATEGORIZATION:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.categorization",{defaultMessage:"Categorization"});case s.f.RARE:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.rare",{defaultMessage:"Rare"});case s.f.GEO:return i.i18n.translate("xpack.ml.newJob.wizard.jobCreatorTitle.geo",{defaultMessage:"Geo"});default:return""}}function C(e,t){for(const n in e)null!==e[n]&&"object"==typeof e[n]&&("aggregations"!==n&&"aggs"!==n||Object.keys(e[n]).forEach((e=>{"aggregations"!==e&&"aggs"!==e&&t.push({id:e,name:e,type:a.a.KEYWORD,aggregatable:!0,counter:!1})})),C(e[n],t))}},122:function(e,t,n){"use strict";n.d(t,"a",(function(){return NewJobCapsService})),n.d(t,"b",(function(){return c}));var i=n(5),a=n.n(i),r=n(118),o=n(101),l=n(129),d=n(11),s=n(182);class NewJobCapsService extends s.a{constructor(e){super(),a()(this,"_catFields",[]),a()(this,"_dateFields",[]),a()(this,"_geoFields",[]),a()(this,"_includeEventRateField",!0),a()(this,"_removeTextFields",!0),a()(this,"_mlApiService",void 0),this._mlApiService=e}get catFields(){return this._catFields}get dateFields(){return this._dateFields}get geoFields(){return this._geoFields}get categoryFields(){return Object(l.c)(this._fields)}async initializeFromDataVIew(e,t=!0,n=!0){try{this._includeEventRateField=t,this._removeTextFields=n;const i=await this._mlApiService.jobs.newJobCaps(e.getIndexPattern(),"rollup"===e.type),{fields:a,aggs:d}=function(e,t){const n=e[t],i=[],a=[],r={},o={};return void 0!==n&&(n.aggs.forEach((e=>{const t={...e,...void 0!==e.fieldIds?{fields:[]}:{}};r[t.id]=t,a.push(t)})),n.fields.forEach((e=>{const t={...e,aggs:[]};void 0!==t.aggIds&&(o[t.id]=t.aggIds),i.push(t)})),i.forEach((e=>{o[e.id].forEach((t=>{!function(e,t){void 0===t.fields&&(t.fields=[]),void 0===e.aggs&&(e.aggs=[]),t.fields.push(e),e.aggs.push(t)}(e,r[t])}))}))),i.forEach((e=>delete e.aggIds)),a.forEach((e=>delete e.fieldIds)),{fields:i,aggs:a}}(i,e.getIndexPattern());!0===this._includeEventRateField&&function(e,t){const n={id:o.c,name:"Event rate",type:r.a.INTEGER,aggregatable:!0,counter:!1,aggs:[]};e.forEach((e=>{void 0!==n.aggs&&void 0===e.fields&&(e.fields=[n],n.aggs.push(e))})),t.splice(0,0,n)}(d,a);const{fieldsPreferringKeyword:c,fieldsPreferringText:u}=Object(s.b)(a),f=u.filter((e=>e.type===r.a.KEYWORD||e.type===r.a.TEXT)),g=u.filter((e=>e.type===r.a.DATE)),b=Object(l.d)(a),_=this._removeTextFields?c:a;this._fields=_,this.removeCounterFields(),this._catFields=f,this._dateFields=g,this._geoFields=b,this._aggs=d}catch(e){console.error("Unable to load new job capabilities",e)}}}const c=new NewJobCapsService(d.ml)},129:function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return o})),n.d(t,"d",(function(){return d})),n.d(t,"e",(function(){return s})),n.d(t,"c",(function(){return c}));var i=n(118),a=n(101);const r=[i.a.TEXT,i.a.KEYWORD,i.a.IP,i.a.VERSION];function o(e,t,n){const r=function(e){return e.filter((e=>e.type===i.a.KEYWORD||e.type===i.a.VERSION))}(e),o=function(e){return e.filter((e=>e.type===i.a.TEXT))}(e),s=function(e){return e.filter((e=>e.type===i.a.LONG||e.type===i.a.UNSIGNED_LONG||e.type===i.a.INTEGER||e.type===i.a.SHORT||e.type===i.a.BYTE||e.type===i.a.DOUBLE||e.type===i.a.FLOAT||e.type===i.a.HALF_FLOAT||e.type===i.a.SCALED_FLOAT))}(e),c=function(e){return e.filter((e=>e.type===i.a.IP))}(e),u=d(e),f=Object.keys(n).length>0,g=function(e,t){return function(n,i){(!1===e||t[n.id]&&t[n.id].find((e=>e.agg===i.dslName)))&&(void 0!==n.aggs&&n.aggs.push(i),void 0!==i.fields&&i.fields.push(n))}}(f,n);return t.forEach((e=>{if(e.type===a.d&&void 0!==e.fields)switch(e.id){case a.n.LAT_LONG:u.forEach((t=>g(t,e)));break;case a.n.INFO_CONTENT:case a.n.HIGH_INFO_CONTENT:case a.n.LOW_INFO_CONTENT:o.forEach((t=>g(t,e)));case a.n.DISTINCT_COUNT:case a.n.HIGH_DISTINCT_COUNT:case a.n.LOW_DISTINCT_COUNT:r.forEach((t=>g(t,e))),c.forEach((t=>g(t,e)));default:s.forEach((t=>{t.aggregatable&&g(t,e)}))}})),{aggs:t,fields:f?l(e):e}}function l(e){return e.filter((e=>e.aggs&&(e.aggs.length>0||0===e.aggs.length&&e.type===i.a.DATE)))}function d(e){return e.filter((e=>e.type===i.a.GEO_POINT||e.type===i.a.GEO_SHAPE))}function s(e){if(0===e.length)return e;let t;return e[0].id===a.c&&([t]=e.splice(0,1)),e.sort(((e,t)=>e.name.localeCompare(t.name))),void 0!==t&&e.splice(0,0,t),e}function c(e,t=!0){return e.filter((e=>r.includes(e.type)===t))}},135:function(e,t,n){"use strict";n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return l}));var i=n(101),a=n(111);function r(){return{job_id:"",description:"",groups:[],analysis_config:{bucket_span:"",detectors:[],influencers:[]},data_description:{time_field:""}}}function o(e){return{datafeed_id:"",job_id:"",indices:Object(a.w)(e),query:{}}}function l(e,t){const n={function:e.id};return t.id!==i.c&&(n.field_name=t.id),n}},182:function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return NewJobCapabilitiesServiceBase}));var i=n(5),a=n.n(i),r=n(118);function o(e){const t=e.filter((e=>e.type===r.a.KEYWORD)).map((e=>e.id)),n=e.filter((e=>e.type===r.a.TEXT)).map((e=>e.id));return{fieldsPreferringKeyword:e.filter((e=>e.type!==r.a.TEXT||e.type===r.a.TEXT&&!1===t.includes(`${e.id}.keyword`))),fieldsPreferringText:e.filter((e=>e.type!==r.a.KEYWORD||e.type===r.a.KEYWORD&&!1===n.includes(e.id.replace(/\.keyword$/,""))))}}class NewJobCapabilitiesServiceBase{constructor(){a()(this,"_fields",void 0),a()(this,"_aggs",void 0),this._fields=[],this._aggs=[]}get fields(){return this._fields}get aggs(){return this._aggs}get newJobCaps(){return{fields:this._fields,aggs:this._aggs}}getFieldById(e){const t=this._fields.find((t=>t.id===e));return void 0===t?null:t}getAggById(e){const t=this._aggs.find((t=>t.id===e));return void 0===t?null:t}removeCounterFields(){this._fields=this._fields.filter((e=>!1===e.counter))}}},231:function(e,t,n){"use strict";n.r(t),n.d(t,"resolver",(function(){return b})),n.d(t,"QuickGeoJobCreator",(function(){return quick_create_job_QuickGeoJobCreator})),n.d(t,"getJobsItemsFromEmbeddable",(function(){return u})),n.d(t,"isCompatibleMapVisualization",(function(){return c})),n.d(t,"redirectToGeoJobWizard",(function(){return s})),n.d(t,"VisualizationExtractor",(function(){return visualization_extractor_VisualizationExtractor}));var i=n(3),a=n(17),r=n(106),o=n(135),l=n(116),d=n(1);async function s(e,t,n,i,a,r){const{query:o,filters:l,to:s,from:c}=await u(e),f=await e.getQuery(),g=await e.getFilters(),b=r.url.locators.get(d.a),_={dashboard:{query:o,filters:l},dataViewId:t,embeddable:{query:f,filters:g},geoField:n,splitField:a,from:c,to:s,...i?{layer:{query:i}}:{}},p=await(null==b?void 0:b.getUrl({page:d.b.ANOMALY_DETECTION_CREATE_JOB_FROM_MAP,pageState:_}));window.open(p,"_blank")}function c(e){return e.getLayerList().some((e=>{const t=e.getGeoFieldNames().length?e.getGeoFieldNames()[0]:void 0,n=e.getIndexPatternIds().length?e.getIndexPatternIds()[0]:void 0;return t&&n}))}async function u(e){var t;const{filters:n,timeRange:a,...r}=e.getInput(),o=void 0===r.query?{query:"",language:"kuery"}:r.query;if(void 0===a)throw Error(i.i18n.translate("xpack.ml.newJob.fromGeo.createJob.error.noTimeRange",{defaultMessage:"Time range not specified."}));const{to:l,from:d}=a;return{from:d,to:l,query:o,filters:n,dashboard:"dashboard"===(null===(t=e.parent)||void 0===t?void 0:t.type)?e.parent:void 0}}var f=n(215),g=n(145);class quick_create_job_QuickGeoJobCreator extends f.a{constructor(e,t,n,i){super(e,t,n,i)}async createAndSaveGeoJob({jobId:e,bucketSpan:t,embeddable:n,startJob:i,runInRealTime:a,dataViewId:o,sourceDataView:l,geoField:d,splitField:s,layerLevelQuery:c}){var f,b;const{query:_,filters:p,to:m,from:y,dashboard:O}=await u(n),v=null!==(f=await n.getQuery())&&void 0!==f?f:Object(g.d)(),T=null!==(b=await n.getFilters())&&void 0!==b?b:[];if(void 0===_||void 0===p)throw new Error("Cannot create job, query and filters are undefined");const{jobConfig:E,datafeedConfig:N,start:h,end:C}=await this.createGeoJob({dataViewId:o,sourceDataView:l,from:y,to:m,query:_,filters:p,embeddableQuery:v,embeddableFilters:T,layerLevelQuery:c,geoField:d,splitField:s,bucketSpan:t});return await this.putJobAndDataFeed({jobId:e,datafeedConfig:N,jobConfig:E,createdByLabel:r.a.GEO,dashboard:O,start:h,end:C,startJob:i,runInRealTime:a})}async createAndStashGeoJob(e,t,n,i,a,o,d,s,c=null,u){try{const{jobConfig:f,datafeedConfig:g,start:b,end:_,includeTimeRange:p}=await this.createGeoJob({dataViewId:e,from:t,to:n,query:i,filters:a,embeddableQuery:o,embeddableFilters:d,geoField:s,splitField:c,layerLevelQuery:u});Object(l.n)({jobConfig:f,datafeedConfig:g,createdBy:r.a.GEO,start:b,end:_},!0,p,!p)}catch(e){console.error(e)}}async createGeoJob({dataViewId:e,sourceDataView:t,from:n,to:a,query:r,filters:o,embeddableQuery:l,embeddableFilters:d,layerLevelQuery:s,geoField:c,splitField:u,bucketSpan:f}){const{jobConfig:g,datafeedConfig:b,jobType:_}=await this.createGeoJobFromMapEmbeddable({sourceDataView:t,dataViewId:e,dashboard:{query:r,filters:o},embeddable:{query:l,filters:d},layerLevelQuery:s,geoField:c,splitField:u,...f?{bucketSpan:f}:{}});let p,m,y=!0;try{const{min:e,max:t}=this.timeFilter.calculateBounds({to:a,from:n});if(p=null==e?void 0:e.valueOf(),m=null==t?void 0:t.valueOf(),void 0===p||void 0===m||isNaN(p)||isNaN(m))throw Error(i.i18n.translate("xpack.ml.newJob.fromLens.createJob.error.timeRange",{defaultMessage:"Incompatible time range"}))}catch(e){console.error(e),y=!1,p=void 0,m=void 0}return{jobConfig:g,datafeedConfig:b,jobType:_,start:p,end:m,includeTimeRange:y}}async createGeoJobFromMapEmbeddable({sourceDataView:e,dataViewId:t,dashboard:n,embeddable:i,layerLevelQuery:l,bucketSpan:d,geoField:s,splitField:c}){const u=e||await Object(a.c)().get(t,!0),f=Object(o.c)(),g=Object(o.b)(u.getIndexPattern()),b=this.combineQueriesAndFilters(n,i,u,l?{query:l,filters:[]}:void 0);return g.query=b,f.analysis_config.detectors=[{function:"lat_long",field_name:s,...c?{partition_field_name:c}:{}}],f.data_description.time_field=u.timeFieldName,f.analysis_config.bucket_span=null!=d?d:r.b,c&&(f.analysis_config.influencers=[c]),{jobConfig:f,datafeedConfig:g,jobType:r.f.GEO}}}async function b(e,t,n,i,a,r,o,l,d){const{kibanaConfig:s,timeFilter:c,dashboardService:u,mlApiServices:f}=e,b={query:Object(g.d)(),filters:[]},_=Object(g.e)(t,b),p=Object(g.e)(i,b),m=void 0!==d?Object(g.e)(d,b):b,y=Object(g.e)(a,""),O=Object(g.e)(r,null),v=Object(g.e)(n,""),T=Object(g.e)(o,""),E=Object(g.e)(l,""),N=new quick_create_job_QuickGeoJobCreator(s,c,u,f);await N.createAndStashGeoJob(v,T,E,_.query,_.filters,p.query,p.filters,y,O,null==m?void 0:m.query)}var _=n(81),p=n(129);class visualization_extractor_VisualizationExtractor{constructor(){}async getResultLayersFromEmbeddable(e){var t,n;const i=[],a=null!==(t=null===(n=e.getRoot())||void 0===n?void 0:n.getAllDataViews())&&void 0!==t?t:[],r={};return await Object(_.asyncForEach)(e.getLayerList(),(async e=>{const t=e.getGeoFieldNames().length?e.getGeoFieldNames()[0]:void 0,n=e.getIndexPatternIds().length?e.getIndexPatternIds()[0]:void 0,o=await e.getDisplayName(),l=await e.getId(),d=await e.getQuery();if(t&&n&&void 0===r[t]){r[t]=!0;const e=a.find((e=>e.id===n));i.push({layerId:l,layerDisplayName:o,geoField:t,dataViewId:n,dataView:e,query:d,...e?{splitFieldOptions:await this.getSplitFieldOptions(e)}:{splitFieldOptions:[]}})}})),i}async getSplitFieldOptions(e){var t;return(null!==(t=e.fields.getAll().sort(((e,t)=>e.name.localeCompare(t.name))))&&void 0!==t?t:[]).filter((e=>p.a.some((t=>{var n;return null===(n=e.esTypes)||void 0===n?void 0:n.includes(t)})))).map((e=>({label:e.name,field:e.name})))}}}}]);