/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */
(window.ml_bundle_jsonpfunction=window.ml_bundle_jsonpfunction||[]).push([[32],{698:function(e,t,a){"use strict";a.r(t),a.d(t,"NotificationsPage",(function(){return $}));var i=a(2),s=a.n(i),n=a(15),l=a(113),o=a(41),c=a.n(o),r=a(3),d=a(29),u=a(31),b=a(155),m=a.n(b),f=a(185),p=a.n(f),j=a(42),g=a(7),O=a(9),y=a(104),x=a(105),h=a(6);const v={anomaly_detector:!0,data_frame_analytics:!0,trained_models:!0},M=({entityTypes:e=v,multiSelect:t=!0,selectedOptions:a,onSelectionChange:s,handleDuplicates:n=!1})=>{const{isADEnabled:l,isDFAEnabled:o,isNLPEnabled:c}=Object(x.d)(),{jobs:u,trainedModels:b,dataFrameAnalytics:m}=Object(O.c)(),{displayErrorToast:f}=Object(y.c)(),j=Object(d.euiPaletteColorBlindBehindText)(),[M,S]=Object(i.useState)(!0),[_,k]=Object(i.useState)([]),E=Object(i.useCallback)((async()=>{try{const t=[];if(l&&null!=e&&e.anomaly_detector){const{jobIds:e}=await u.getAllJobAndGroupIds();t.push({label:r.i18n.translate("xpack.ml.mlEntitySelector.adOptionsLabel",{defaultMessage:"Anomaly detection jobs"}),isGroupLabelOption:!0,color:j[0],options:e.map((e=>({label:e,value:e,id:`anomaly_detector:${e}`,key:`anomaly_detector:${e}`,color:j[0],"data-test-subj":"mlAdJobOption"})))})}if(o&&null!=e&&e.data_frame_analytics){const e=await m.getDataFrameAnalytics();e.count>0&&t.push({label:r.i18n.translate("xpack.ml.mlEntitySelector.dfaOptionsLabel",{defaultMessage:"Data frame analytics"}),isGroupLabelOption:!0,options:e.data_frame_analytics.map((({id:e})=>({label:e,value:e,id:`data_frame_analytics:${e}`,key:`data_frame_analytics:${e}`,color:j[2],"data-test-subj":"mlDfaJobOption"})))})}if((o||c)&&null!=e&&e.trained_models){const e=await b.getTrainedModels();e.length>0&&t.push({label:r.i18n.translate("xpack.ml.mlEntitySelector.trainedModelsLabel",{defaultMessage:"Trained models"}),isGroupLabelOption:!0,options:e.map((({model_id:e})=>({label:e,value:e,id:`trained_models:${e}`,key:`trained_models:${e}`,color:j[3],"data-test-subj":"mlTrainedModelOption"})))})}k(t)}catch(e){f(e,r.i18n.translate("xpack.ml.mlEntitySelector.fetchError",{defaultMessage:"Failed to fetch ML entities"}))}S(!1)}),[u,b,m,e,j,f,l,o,c]);p()((function(){E()}));const F=Object(i.useMemo)((()=>(null!=a?a:[]).flatMap((e=>{const t=_.flatMap((e=>e.options)).filter((t=>t.value===e.id));return t.length>0?t:[{value:e.id,label:e.id,key:`unknown:${e.id}`,"data-test-subj":`mlUnknownOption ${e.id}`}]}))),[_,a]),T=Object(i.useCallback)((e=>{if(!s)return;let t=e;if(n){const a=Object(g.countBy)(F,"value"),i=Object(g.countBy)(e,"value");t=t.filter((({value:e})=>!(a[e]>1&&i[e]<a[e])))}s(t.map((e=>{const[t]=e.key.split(":");return{id:e.value,type:t}})))}),[s,F,n]);return Object(h.jsx)(d.EuiComboBox,{autoFocus:!0,isLoading:M,singleSelection:!t,selectedOptions:F,options:_,onChange:T,fullWidth:!0,"data-test-subj":"mlEntitySelector_"+(M?"loading":"loaded"),isInvalid:!1})};var S={name:"18ji2p4",styles:"width:300px"};const _=s.a.memo((({query:e,onChange:t})=>{const[a,s]=Object(i.useState)(!1),l=e.hasOrFieldClause("job_id")||e.hasSimpleFieldClause("job_id"),o=e.getOrFieldClause("job_id"),c=e.getSimpleFieldClause("job_id"),r=s.bind(null,!1),u=Object(i.useMemo)((()=>{let e=[];return o&&Array.isArray(o.value)&&(e=o.value.map((e=>({id:e})))),c&&c.value&&e.push({id:c.value}),e}),[o,c]),b=Object(i.useCallback)((a=>{let i=e.removeOrFieldClauses("job_id");i=i.removeSimpleFieldClauses("job_id"),a.length>0&&(i=Object(g.uniqBy)(a,"id").reduce(((e,t)=>e.addOrFieldValue("job_id",t.id,!0,"eq")),i)),t(i)}),[t,e]),m=Object(h.jsx)(d.EuiFilterButton,{iconType:"arrowDown",iconSide:"right",onClick:s.bind(null,(e=>!e)),hasActiveFilters:l,numActiveFilters:l?u.length:void 0,grow:!0},Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.entityFilter",defaultMessage:"Entity"}));return Object(h.jsx)(d.EuiPopover,{button:m,isOpen:a,closePopover:r,panelPaddingSize:"none",anchorPosition:"downCenter"},Object(h.jsx)(d.EuiPanel,{paddingSize:"s",css:S},Object(h.jsx)(M,{selectedOptions:u,onSelectionChange:b,handleDuplicates:!0})))}));var k=a(286);const E="error",F="info",T="warning";var w=a(162),C=a(45),A=a(150),L=a(190),D=a(1);const I={[E]:"danger",[T]:"warning",[F]:"default"},N=()=>{const{services:{mlServices:{mlApiServices:e}}}=Object(O.d)(),{isADEnabled:t,isDFAEnabled:a,isNLPEnabled:o}=Object(x.d)(),{displayErrorToast:b}=Object(y.c)(),{lastCheckedAt:f,setLastCheckedAt:g,notificationsCounts:v,latestRequestedAt:M}=Object(k.b)(),S=Object(l.i)(),N=Object(l.h)();p()((function(){null!==M&&S.setTime({from:c()(M).toISOString(),to:"now"})}));const[B,z]=Object(i.useState)(!0),[P,q]=Object(i.useState)([]),[$,R]=Object(i.useState)(0),[Q,G]=Object(i.useState)(""),J=Object(C.b)(u.FIELD_FORMAT_IDS.DATE),[W,U]=Object(j.c)(D.b.NOTIFICATIONS,{pageIndex:0,pageSize:25,sortField:"timestamp",sortDirection:"desc"}),{onTableChange:V,pagination:H,sorting:K}=Object(L.a)($,W,U),X=Object(A.a)(),Y=W.queryText,Z=Object(i.useMemo)((()=>{try{return G(""),d.EuiSearchBar.Query.parse(null!=Y?Y:"")}catch(e){G(e.message)}}),[Y,G]),ee=Object(i.useCallback)((async()=>{if(!Z)return;const t=d.EuiSearchBar.Query.toESQueryString(Z);try{z(!0);const a=await e.notifications.findMessages({sortField:K.sort.field,sortDirection:K.sort.direction,earliest:N.from,latest:N.to,queryString:t});q(a.results),R(a.total)}catch(e){b(e,r.i18n.translate("xpack.ml.notifications.fetchFailedError",{defaultMessage:"Fetch notifications failed"}))}z(!1)}),[K,Z,e.notifications,b,N]);Object(i.useEffect)((function(){const e=H.pageIndex*H.pageSize,t=P.slice(e,e+H.pageSize),a=Math.max(...t.map((e=>e.timestamp)),null!=f?f:0);a!==f&&0!==a&&g(a)}),[f,g,P,H.pageIndex,H.pageSize]),m()((function(){ee()}),500,[K,Z,X]);const te=Object(i.useMemo)((()=>[{id:"timestamp",field:"timestamp",name:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.timeLabel",defaultMessage:"Time"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationTime",width:"250px",render:e=>J(e)},{field:"level",name:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.levelLabel",defaultMessage:"Level"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationLevel",render:e=>Object(h.jsx)(d.EuiBadge,{color:I[e]},e),width:"100px"},{field:"job_type",name:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.typeLabel",defaultMessage:"Type"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationType",render:e=>Object(h.jsx)(d.EuiBadge,{color:"hollow"},e),width:"200px"},{field:"job_id",name:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.entityLabel",defaultMessage:"Entity ID"}),sortable:!0,truncateText:!1,"data-test-subj":"mlNotificationEntity",width:"200px"},{field:"message",name:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.messageLabel",defaultMessage:"Message"}),sortable:!1,truncateText:!1,"data-test-subj":"mlNotificationMessage"}]),[J]),ae=Object(i.useMemo)((()=>{const e=[];return!0===t&&e.push({value:"anomaly_detector",name:r.i18n.translate("xpack.ml.notifications.filters.type.anomalyDetector",{defaultMessage:"Anomaly Detection"})}),!0===a&&e.push({value:"data_frame_analytics",name:r.i18n.translate("xpack.ml.notifications.filters.type.dfa",{defaultMessage:"Data Frame Analytics"})}),!0!==o&&!0!==a||e.push({value:"inference",name:r.i18n.translate("xpack.ml.notifications.filters.type.inference",{defaultMessage:"Inference"})}),e.push({value:"system",name:r.i18n.translate("xpack.ml.notifications.filters.type.system",{defaultMessage:"System"})}),[{type:"field_value_selection",field:"level",name:r.i18n.translate("xpack.ml.notifications.filters.level.name",{defaultMessage:"Level"}),multiSelect:"or",options:[{value:E,name:r.i18n.translate("xpack.ml.notifications.filters.level.error",{defaultMessage:"Error"}),field:"level"},{value:T,name:r.i18n.translate("xpack.ml.notifications.filters.level.warning",{defaultMessage:"Warning"}),field:"level"},{value:F,name:r.i18n.translate("xpack.ml.notifications.filters.level.info",{defaultMessage:"Info"}),field:"level"}]},{type:"field_value_selection",field:"job_type",name:r.i18n.translate("xpack.ml.notifications.filters.level.type",{defaultMessage:"Type"}),multiSelect:"or",options:e},{type:"custom_component",component:_}]}),[t,a,o]),ie=Object.values(v).reduce(((e,t)=>e+t)),se=Object(i.useMemo)((()=>{const e=H.pageIndex*H.pageSize,t=e+H.pageSize;return P.slice(e,t)}),[P,H]);return Object(h.jsx)(s.a.Fragment,null,Object(h.jsx)(w.a,{onCloseFlyout:ee,forceRefresh:B}),ie&&!B?Object(h.jsx)(s.a.Fragment,null,Object(h.jsx)(d.EuiCallOut,{size:"s",title:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.newNotificationsMessage",defaultMessage:"There {newNotificationsCount, plural, one {is # notification} other {are # notifications}} since {sinceDate}. Refresh the page to view updates.",values:{sinceDate:J(M),newNotificationsCount:ie}}),iconType:"bell"}),Object(h.jsx)(d.EuiSpacer,{size:"m"})):null,Object(h.jsx)(d.EuiSearchBar,{query:Z,box:{placeholder:r.i18n.translate("xpack.ml.notifications.searchPlaceholder",{defaultMessage:"Search for notifications. Example: job_type:anomaly_detector -level:(info) Datafeed"}),incremental:!1,schema:{strict:!0,fields:{level:{type:"string",name:"level",searchable:!1,aggregatable:!0},job_type:{type:"string",name:"job_type",searchable:!1,aggregatable:!0},job_id:{type:"string",name:"job_id",searchable:!1,aggregatable:!0},message:{type:"string",name:"message",searchable:!0,aggregatable:!1}}},"data-test-subj":"mlNotificationsSearchBarInput"},filters:ae,onChange:e=>{U({queryText:e.queryText})},"data-test-subj":"mlNotificationsSearchBar"}),Object(h.jsx)(d.EuiSpacer,{size:"m"}),Q?Object(h.jsx)(s.a.Fragment,null,Object(h.jsx)(d.EuiCallOut,{size:"s",title:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.invalidQueryError",defaultMessage:"Query is not valid: "}),color:"danger",iconType:"warning"},Object(h.jsx)("p",null,Q)),Object(h.jsx)(d.EuiSpacer,{size:"m"})):null,Object(h.jsx)(d.EuiBasicTable,{columns:te,hasActions:!1,isExpandable:!1,isSelectable:!1,items:se,itemId:"id",loading:B,rowProps:e=>({"data-test-subj":`mlNotificationsTableRow row-${e.id}`}),pagination:H,onChange:V,sorting:K,"data-test-subj":B?"mlNotificationsTable loading":"mlNotificationsTable loaded",noItemsMessage:Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.noItemsFoundMessage",defaultMessage:"No notifications found"})}))};var B=a(114),z=a(36),P=a(208),q=a(124);const $=()=>{const{services:{docLinks:e}}=Object(O.d)(),t=e.links.ml.guide;return Object(l.i)({timeRangeSelector:!0,autoRefreshSelector:!0}),Object(h.jsx)("div",null,Object(h.jsx)(B.a,null,Object(h.jsx)(n.FormattedMessage,{id:"xpack.ml.notifications.notificationsLabel",defaultMessage:"Notifications"})),Object(h.jsx)(z.b,null),Object(h.jsx)(P.a,null),Object(h.jsx)(N,null),Object(h.jsx)(q.a,{docLink:t}))};t.default=$}}]);